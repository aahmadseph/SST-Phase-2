FROM node:16.16.0

# Update local timezone to PST
RUN date
RUN ln -sf /usr/share/zoneinfo/America/Los_Angeles /etc/localtime
RUN echo "America/Los_Angeles" > /etc/timezone
RUN date

# Configuration of environment variables
ARG CICD_VERSION
RUN echo $CICD_VERSION
ENV UFE_CICD_VERSION=$CICD_VERSION

# Set debconf to Noninteractive to suppress next warning:
#     debconf: unable to initialize frontend: Dialog
#     debconf: (TERM is not set, so the dialog frontend is not usable.)
#     debconf: falling back to frontend: Readline
#     debconf: unable to initialize frontend: Readline
#     debconf: (This frontend requires a controlling tty.)
#     debconf: falling back to frontend: Teletype
#     dpkg-preconfigure: unable to re-open stdin:
ARG DEBIAN_FRONTEND=noninteractive

# Installation of general dependencies
RUN apt-get update -y && apt-get upgrade -y && apt-get install -y \
    apt-utils \
    ca-certificates \
    gnupg \
    lsb-release

# Installation of Google Chrome
RUN wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
RUN echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list
RUN apt-get update -y && apt-get install -y google-chrome-stable
# After Chrome installation /etc/apt/sources.list.d/google-chrome.list file will be created.
# As a result it leads to this warning:
#     W: Target Packages (main/binary-amd64/Packages) is configured multiple times in /etc/apt/sources.list.d/google-chrome.list:3 and /etc/apt/sources.list.d/google.list:1
#     W: Target Packages (main/binary-all/Packages) is configured multiple times in /etc/apt/sources.list.d/google-chrome.list:3 and /etc/apt/sources.list.d/google.list:1
#     W: Target Packages (main/binary-amd64/Packages) is configured multiple times in /etc/apt/sources.list.d/google-chrome.list:3 and /etc/apt/sources.list.d/google.list:1
#     W: Target Packages (main/binary-all/Packages) is configured multiple times in /etc/apt/sources.list.d/google-chrome.list:3 and /etc/apt/sources.list.d/google.list:1
# To avoid this warning, we delete the google.list file we created and keep the google-chrome.list generated by the installer.
RUN rm /etc/apt/sources.list.d/google.list

# Installation of Docker
RUN mkdir -p /etc/apt/keyrings
RUN curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
RUN echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
RUN apt-get update -y && apt-get install -y \
    docker-ce \
    docker-ce-cli \
    # docker-compose-plugin \
    containerd.io

ARG UFE_ARTIFACTORY_TOKEN
RUN echo $UFE_ARTIFACTORY_TOKEN
RUN mkdir -p "/root/.docker"
RUN curl -j -k -L --header "Private-Token: $UFE_ARTIFACTORY_TOKEN" https://gitlab.lipstack.sephoraus.com/api/v4/projects/17/repository/files/master%2Fhome%2F.docker%2Fconfig.json/raw?ref=master -o /root/.docker/config.json

# Create the nodejs user and switch to it
RUN apt-get install -y sudo
RUN addgroup --system nodejs
RUN adduser --system nodejs --ingroup nodejs
RUN echo "nodejs:nodejs" | chpasswd
RUN usermod -aG sudo nodejs
USER nodejs

# To avoid this message:
#   fatal: detected dubious ownership in repository at '/builds/illuminate/frontend/ufe'
RUN git config --global --add safe.directory /builds/illuminate/frontend/ufe

RUN node --version && \
    npm --version && \
    google-chrome-stable --version && \
    docker --version && \
    echo $UFE_CICD_VERSION && \
    pwd && \
    ls -la && \
    pwd

# CMD tail -f /dev/null
