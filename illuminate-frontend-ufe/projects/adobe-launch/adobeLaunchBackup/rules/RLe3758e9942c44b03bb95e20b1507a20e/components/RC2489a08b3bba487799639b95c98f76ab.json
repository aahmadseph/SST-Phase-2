{
    "id": "RC2489a08b3bba487799639b95c98f76ab",
    "type": "rule_components",
    "attributes": {
        "created_at": "2024-01-25T15:52:35.695Z",
        "delegate_descriptor_id": "core::actions::custom-code",
        "deleted_at": null,
        "dirty": false,
        "name": "SOT - P13n Events Tracking",
        "negate": false,
        "order": 1,
        "rule_order": 50,
        "timeout": 2000,
        "delay_next": true,
        "published": true,
        "published_at": null,
        "revision_number": 0,
        "updated_at": "2025-06-24T12:59:46.982Z",
        "created_by_email": "abhinav.alkuchi@sephora.com",
        "created_by_display_name": "abhinav alkuchi",
        "updated_by_email": "abhinav.alkuchi@sephora.com",
        "updated_by_display_name": "abhinav alkuchi",
        "settings": "{\"source\":\"(async function () {\\n  function readCookie(name) {\\n    var nameEQ = name + \\\"=\\\";\\n    var ca = document.cookie.split(\\\";\\\");\\n    for (var i = 0; i \\u003c ca.length; i++) {\\n      var c = ca[i];\\n      while (c.charAt(0) === \\\" \\\") c = c.substring(1, c.length);\\n      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);\\n    }\\n    return null;\\n  }\\n\\n  function getEventAttribute(attributePath) {\\n    return Sephora.analytics.utils.getMostRecentEventProperty({\\n      pathToProperty: attributePath,\\n      fallBackEventName: Sephora.analytics.constants.LINK_TRACKING_EVENT,\\n    });\\n  }\\n\\n  function safelyReadProperty(attributePath, objectInfo) {\\n    return Sephora.analytics.utils.safelyReadProperty(\\n      attributePath,\\n      objectInfo\\n    );\\n  }\\n\\n  function getEventDetail(attributePath) {\\n    const data = event.detail;\\n    return data ? safelyReadProperty(attributePath, data) : \\\"\\\";\\n  }\\n\\n  function getLinkName() {\\n    let linkName = \\\"\\\";\\n    if (getEventDetail(\\\"data\\\") \\u0026\\u0026 getEventDetail(\\\"data.linkName\\\")) {\\n      linkName = getEventDetail(\\\"data.linkName\\\");\\n    } else {\\n      linkName = getEventAttribute(\\\"eventInfo.attributes.linkName\\\");\\n    }\\n    return linkName;\\n  }\\n\\n  function getEmailId() {\\n    return digitalData?.user?.[0]?.profile?.[0]?.profileInfo?.email || \\\"\\\";\\n  }\\n\\n  function getEventId(index) {\\n    const { uniqueId } = digitalData.page.attributes;\\n    const { profileID } = digitalData.user[0].profile[0].profileInfo;\\n    const { anonymousUserId } = digitalData;\\n    const digitalDataTimestamp = new Date().getTime() + index;\\n\\n    if (digitalDataTimestamp) {\\n      if (uniqueId) {\\n        return uniqueId + digitalDataTimestamp;\\n      } else if (profileID) {\\n        return profileID + digitalDataTimestamp;\\n      } else if (anonymousUserId) {\\n        return anonymousUserId + digitalDataTimestamp;\\n      } else {\\n        return (\\n          _satellite.getVar(\\\"[UEID] :: Universal Event ID Fx\\\")(event) ||\\n          _satellite.getVar(\\\"[TMS] :: Event Id\\\") ||\\n          \\\"-1\\\"\\n        );\\n      }\\n    } else {\\n      return \\\"-2\\\";\\n    }\\n  }\\n\\n  function createCacheKeyPrefix() {\\n    const { country, language } = Sephora.renderQueryParams;\\n    const P13N_DATA = \\\"P13N_DATA\\\";\\n    return `${P13N_DATA}_${country}-${language}`;\\n  }\\n\\n  function setPersonalizationKey(context) {\\n    return `${createCacheKeyPrefix()}_${context}`;\\n  }\\n\\n  function getVariationFromStorage(context) {\\n    let variationId = \\\"\\\";\\n    const data = window.localStorage.getItem(setPersonalizationKey(context));\\n    const parsedData = JSON.parse(data);\\n    if (\\n      parsedData \\u0026\\u0026\\n      parsedData.data \\u0026\\u0026\\n      parsedData.data.context === context \\u0026\\u0026\\n      parsedData.data.p13n \\u0026\\u0026\\n      parsedData.data.p13n.variation !== \\\"\\\" \\u0026\\u0026\\n      emailId !== \\\"\\\"\\n    ) {\\n      variationId = parsedData.data.p13n.variation;\\n    }\\n    return variationId;\\n  }\\n\\n  function getPublishedVersionBySid(sid) {\\n    const data = Sephora.homePageItems || [];\\n    for (let i = 0; i \\u003c data.length; i++) {\\n      const currentItem = data[i];\\n      if (currentItem.sid === sid) {\\n        return currentItem?.sys?.publishedVersion || null;\\n      }\\n      const items = currentItem.items || [];\\n      if (items) {\\n        for (let j = 0; j \\u003c items.length; j++) {\\n          if (items[j].sid === sid) {\\n            return items[j]?.sys?.publishedVersion || null;\\n          }\\n        }\\n      }\\n    }\\n    return null; // Return null if the sid is not found\\n  }\\n\\n  function getCmsBannerData() {\\n    const personalizationData = getEventDetail(\\\"data.personalizationData\\\");\\n    if (!personalizationData) return;\\n\\n    const {\\n      sid: componentSid,\\n      contentType,\\n      title: componentTitle,\\n      publishedVersion: parentPublishedVersion,\\n      bannersPersonalizedData = []\\n    } = personalizationData;\\n\\n    const emailAvailable = getEmailId() !== \\\"\\\";\\n\\n    return bannersPersonalizedData.map((banner, index) =\\u003e {\\n      const {\\n        sid: itemSid,\\n        skuId = null,\\n        publishedVersion: itemPublishedVersion,\\n        promoId: itemPromotionId,\\n        promoCode: itemPromoCode,\\n        ruleId: itemRuleId,\\n        ruleSetId: itemRuleSetId,\\n        p13n = {},\\n        personalization = {},\\n        itemIndex = \\\"n/a\\\",\\n        isABTestEnabled = null,\\n        isNBCEnabled: isNBCEnabledData = null,\\n        NBCSlotCounts = null\\n      } = banner;\\n      \\n\\n      const context = p13n?.context || personalizationData?.p13n?.context || null;\\n      const variation = p13n?.variation || personalizationData?.p13n?.variation || getVariationFromStorage(context) || null;\\n      const boVersion = p13n?.boVersion || personalizationData?.p13n?.boVersion || null;\\n      const isDefault = (typeof personalization?.isDefault === 'boolean') ? personalization?.isDefault : (typeof p13n?.isDefault === 'boolean') ? p13n.isDefault : (typeof personalizationData?.p13n?.isDefault === 'boolean') ? personalizationData.p13n.isDefault: null;\\n      const isControl = (typeof personalization?.isControl === 'boolean') ? personalization?.isControl : (typeof p13n?.isControl === 'boolean') ? p13n.isControl : (typeof personalizationData?.p13n?.isControl === 'boolean') ? personalizationData.p13n.isControl : null;\\n      const isAbTest = (typeof personalization?.isAbTest === 'boolean') ? personalization?.isAbTest : (typeof isABTestEnabled === 'boolean') ? isABTestEnabled : (typeof p13n?.isAbTest === 'boolean') ? p13n.isAbTest : (typeof personalizationData?.p13n?.isAbTest === 'boolean') ?  personalizationData.p13n.isAbTest : null;\\n      const isNBCEnabled = (typeof personalization?.isNBCEnabled === 'boolean') ? personalization?.isNBCEnabled : (typeof isNBCEnabledData === 'boolean') ? isNBCEnabledData : (typeof p13n?.isNBCEnabled === 'boolean') ? p13n.isNBCEnabled : (typeof personalizationData?.p13n?.isNBCEnabled === 'boolean') ? personalizationData.p13n.isNBCEnabled: null;\\n      const isNBOEnabled = (typeof personalization?.isNBOEnabled === 'boolean') ? personalization?.isNBOEnabled : (typeof p13n?.isNBOEnabled === 'boolean') ? p13n.isNBOEnabled : (typeof personalizationData?.p13n?.isNBOEnabled === 'boolean') ? personalizationData.p13n.isNBOEnabled: null;\\n      const isMABEnabled = (typeof personalization?.isMABEnabled === 'boolean') ? personalization?.isMABEnabled : (typeof p13n?.isMABEnabled === 'boolean') ? p13n.isMABEnabled : (typeof personalizationData?.p13n?.isMABEnabled === 'boolean') ? personalizationData.p13n.isMABEnabled: null;\\n      const p13nPromoId = p13n?.promoId || personalizationData?.p13n?.promoId || null;\\n      const p13nPromoCode = p13n?.promoCode || personalizationData?.p13n?.promoCode || null;\\n      const nbcSlotCount = NBCSlotCounts? NBCSlotCounts : personalization?.NBCSlotCounts?.web ? personalization?.NBCSlotCounts.web: null;\\n      const ruleId = itemRuleId || banner?.p13n?.ruleId || personalizationData?.p13n?.ruleId || p13n?.ruleId || null;\\n      const ruleSetId = itemRuleSetId || banner?.p13n?.ruleSetId || personalizationData?.p13n?.ruleSetId || p13n?.ruleSetId || null;\\n      return {\\n        sotV04: skuId,\\n        sotV28: itemPromoCode || p13nPromoCode,\\n        sotV233: componentTitle ? componentTitle : \\\"n/a\\\",\\n        sotV297: itemPromotionId || p13nPromoId,\\n        sotV309: nbcSlotCount,\\n        sotV310: itemSid,\\n        sotV311: componentSid || \\\"n/a\\\",\\n        sotV312: contentType || \\\"n/a\\\",\\n        sotV313: emailAvailable ? context : \\\"n/a\\\",\\n        sotV314: emailAvailable ? variation : \\\"n/a\\\",\\n        sotV315:\\n          parentPublishedVersion ||\\n          getPublishedVersionBySid(componentSid) ||\\n          \\\"n/a\\\",\\n        sotV316: \\n          itemPublishedVersion || \\n          getPublishedVersionBySid(itemSid) ||\\n          \\\"n/a\\\",\\n        sotV317: itemIndex,\\n        sotV318: boVersion,\\n        sotV342: isDefault,\\n        sotV343: isControl,\\n        sotV344: isAbTest,\\n        sotV395: isNBCEnabled,\\n        sotV396: isNBOEnabled,\\n        sotV397: isMABEnabled,\\n        sotV412: ruleId,\\n        sotV413: ruleSetId,\\n        eventTime: Date.now() + index,\\n        eventId: getEventId(index) || _satellite.getVar(\\\"[TMS] :: Event Id\\\"),\\n      };\\n    });\\n  }\\n\\n  function getValidLinkName(sotType) {\\n    if (\\n      typeof sotType === \\\"undefined\\\" ||\\n      sotType === null ||\\n      sotType === \\\"null\\\"\\n    ) {\\n      return false;\\n    }\\n    return true;\\n  }\\n\\n  function formatSotType(sotType) {\\n    return sotType \\u0026\\u0026 sotType.toLowerCase().replace(/([\\\\:\\\\-])/g, \\\" \\\");\\n  }\\n\\n  function removeNullValues(obj) {\\n    for (let key in obj) {\\n      if (obj[key] === null || obj[key] === \\\"n/a\\\") {\\n        delete obj[key];\\n      }\\n    }\\n    return obj;\\n  }\\n\\n  function getPlatform() {\\n    const isMobile = Sephora.isMobile();\\n    if (isMobile) {\\n      return \\\"mobile\\\";\\n    } else if (Sephora.isTouch \\u0026\\u0026 !isMobile) {\\n      return \\\"tablet web\\\";\\n    } else {\\n      return \\\"desktop web\\\";\\n    }\\n  }\\n\\n  function getDataFromLocalStorage(key) {\\n    return JSON.parse(window.localStorage.getItem(key)) || null;\\n  }\\n\\n  try {\\n    var linkName = getLinkName();\\n    var atgId = _satellite.getVar(\\n      \\\"[TMS] Async :: User :: ATG ID - page load or async page load\\\"\\n    );\\n    var ccpaConsentCookie = readCookie(\\\"ccpaConsentCookie\\\") === '1' ? 1 : 0;\\n    var timeZone = digitalData?.page?.attributes?.date?.timeZone || \\\"\\\";\\n    var timeZoneName = digitalData?.page?.attributes?.date?.timeZoneName || \\\"\\\";\\n    var fbpValue = readCookie(\\\"_fbp\\\") || \\\"\\\";\\n    var fbcValue = readCookie(\\\"_fbc\\\") || \\\"\\\";\\n    var platform =\\n      digitalData?.page?.attributes?.platform || getPlatform() || \\\"\\\";\\n    var emailId = getEmailId();\\n    var signInStatus = digitalData?.user?.[0]?.segment?.signInStatus || \\\"\\\";\\n    var biAccountId = digitalData?.user?.[0]?.segment?.biAccountId || \\\"\\\";\\n    var biStatus = digitalData?.user?.[0]?.segment?.biStatus || \\\"\\\";\\n    var biPoints = digitalData?.user?.[0]?.segment?.biPoints || 0;\\n    var timestamp = new Date().getTime();\\n    var languageLocale =\\n      safelyReadProperty(\\\"page.attributes.languageLocale\\\", digitalData)\\n        ?.toLowerCase()\\n        ?.slice(-2) || \\\"\\\";\\n    var pageTitle =\\n      digitalData?.page?.attributes?.sephoraPageInfo?.pageName || \\\"\\\";\\n    var profileId =\\n      digitalData?.user?.[0]?.profile?.[0]?.profileInfo?.profileID || \\\"\\\";\\n    let cmsComponentEvents = [\\n      \\\"cms viewable impression\\\",\\n      \\\"cms component item click\\\",\\n    ];\\n\\n    const bannerData =\\n      linkName \\u0026\\u0026 cmsComponentEvents.includes(linkName) ? (getCmsBannerData() || []) : null;\\n    const formattedData =\\n      bannerData?.length \\u003e 0 ? bannerData.map(removeNullValues) : [];\\n    const cmsPageTitle = getEventDetail(\\\"data.title\\\") || \\\"\\\";\\n    var sc_click_id = sessionStorage.getItem(\\\"sc_click_id\\\") || \\\"\\\";\\n    let epikLS = JSON.parse(window.localStorage.getItem(\\\"_epik_ls\\\"));\\n    let epikLSValid =\\n      epikLS?.expires \\u0026\\u0026\\n      epikLS?.value \\u0026\\u0026\\n      !isNaN(new Date(epikLS.expires)) \\u0026\\u0026\\n      new Date(epikLS.expires) \\u003e= new Date();\\n    let epikId =\\n      new URL(window.location.href).searchParams.get(\\\"epik\\\") ||\\n      _satellite.cookie.get(\\\"_epik\\\") ||\\n      (epikLSValid \\u0026\\u0026 epikLS.value) ||\\n      \\\"\\\";\\n    let ipAddress = await _satellite.getVar(\\\"[SOT] System :: IP Address\\\");\\n\\n    const utmParameters = JSON.parse(window.localStorage.getItem(\\\"utmParameters\\\"));\\n    const allowUtm = utmParameters?.expiration \\u003e= new Date().getTime() ? true : \\\"\\\";\\n    const country = _satellite.getVar(\\\"[TMS] Page :: Country\\\");\\n    const contentCountry = digitalData?.page?.attributes?.sephoraPageInfo?.contentCountry || (country ? `content:${country.toLowerCase()}` : \\\"\\\");\\n    const previousPageType = digitalData?.page?.attributes?.previousPageData?.pageType || \\\"\\\";\\n    const {\\n      utm_id,\\n      utm_source,\\n      utm_medium,\\n      utm_campaign,\\n      utm_source_platform,\\n      utm_term,\\n      utm_content,\\n      utm_creative_format,\\n      utm_marketing_tactic\\n    } = allowUtm ? utmParameters : {};\\n    const lowerCaseParams = new URLSearchParams(\\n      Array.from(new URLSearchParams(new URL(window.location.href).search), ([key, value]) =\\u003e [key.toLowerCase(), value])\\n    );\\n    const rdtCidURL = lowerCaseParams.get('rdt_cid');\\n    rdtCidURL \\u0026\\u0026 sessionStorage.setItem('rdt_cid', rdtCidURL);\\n\\n    var dataPayload = {\\n      sysInfo: {\\n        userLanguage: languageLocale,\\n        ipAddress: ipAddress || _satellite.getVar(\\\"[TMS] System Var - IP\\\"),\\n      },\\n      pageInfo: { title: pageTitle || cmsPageTitle },\\n      session: {\\n        biId: biAccountId,\\n        biTier: biStatus,\\n        biPoints: biPoints,\\n        profileId: profileId,\\n        platform: platform,\\n        emailId: emailId,\\n        signInState: signInStatus,\\n        timestamp: timestamp,\\n        atgId: atgId,\\n      },\\n      sotProps: { sot20: timestamp + \\\"\\\" },\\n      sotVars: {\\n        sotV106: _satellite.getVar(\\\"[TMS] Page :: Previous Page Name\\\") || \\\"\\\",\\n        sotV107: _satellite.getVar(\\\"[TMS] Page :: Previous Page Type\\\") || previousPageType,\\n        sotV109: _satellite.getVar(\\\"[TMS] Page :: Content Country\\\") || contentCountry,\\n        sotV119: country,\\n        sotV225: \\\"AL\\\",\\n        sotV226: false,\\n        sotV13: ccpaConsentCookie,\\n        sotV238: timeZone,\\n        sotV246: timeZoneName,\\n        sotV12: fbpValue,\\n        sotV232: fbcValue,\\n        sotV237: _satellite.getVar(\\\"[SOT] Page :: language locale\\\"),\\n        sotV277: ipAddress || \\\"\\\",\\n        sotV278: _satellite.readCookie(\\\"referrer\\\") || \\\"\\\",\\n        sotV295: sc_click_id,\\n        sotV302: _satellite.readCookie(\\\"ttclid\\\") || \\\"\\\",\\n        sotV303: _satellite.readCookie(\\\"_ttp\\\") || \\\"\\\",\\n        sotV324: new URL(window.location.href).searchParams.get(\\\"gclid\\\") || \\\"\\\",\\n        sotV325: epikId,\\n        sotV327: _satellite.getVar(\\\"[SOT] :: Forter Token\\\") || \\\"\\\",\\n        sotV341: _satellite.getVar(\\\"[SOT] :: URL Navigation History\\\") || \\\"\\\",\\n        sotV349: utm_id,\\n        sotV350: utm_source,\\n        sotV351: utm_medium,\\n        sotV352: utm_campaign,\\n        sotV353: utm_source_platform,\\n        sotV354: utm_term,\\n        sotV355: utm_content,\\n        sotV356: utm_creative_format,\\n        sotV357: utm_marketing_tactic,\\n        sotV361: sessionStorage.getItem('rdt_cid'),\\n        sotV362: _satellite.readCookie('_rdt_uuid') || \\\"\\\",\\n        sotV399: _satellite.getVar(\\\"[SOT] Page :: event_date_PST\\\")\\n      },\\n      eventTime: timestamp,\\n      eventId:\\n        _satellite.getVar(\\\"[UEID] :: Universal Event ID Fx\\\")(event) ||\\n        _satellite.getVar(\\\"[TMS] :: Event Id\\\"),\\n    };\\n\\n    if (linkName === \\\"cms viewable impression\\\") {\\n      dataPayload.sotVars.cmsComponentImpressions = formattedData || null;\\n    } else if (linkName === \\\"cms component item click\\\") {\\n      dataPayload.sotVars =\\n        { ...dataPayload.sotVars, ...formattedData[0] } || dataPayload.sotVars;\\n    }\\n\\n    var isValidLinkName = getValidLinkName(linkName);\\n    if (isValidLinkName \\u0026\\u0026 cmsComponentEvents.includes(linkName)) {\\n      (window.sephoraOneTag_cmds = window.sephoraOneTag_cmds || []).push([\\n        \\\"trackEvent\\\",\\n        formatSotType(linkName),\\n        dataPayload,\\n        null,\\n        true,\\n      ]);\\n    }\\n  } catch (error) {\\n    console.log(\\\"Failed SOTP13nEventsTracking Tag\\\", error);\\n  }\\n})();\\n\",\"language\":\"javascript\"}"
    },
    "relationships": {
        "updated_with_extension_package": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC2489a08b3bba487799639b95c98f76ab/updated_with_extension_package"
            },
            "data": {
                "id": "EP1fdd2a6ec2ae468fb1d2cac08df65f83",
                "type": "extension_packages"
            }
        },
        "updated_with_extension": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC2489a08b3bba487799639b95c98f76ab/updated_with_extension"
            },
            "data": {
                "id": "EX35ce3802460d499b9f4c856d69a764b4",
                "type": "extensions"
            }
        },
        "extension": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC2489a08b3bba487799639b95c98f76ab/extension"
            },
            "data": {
                "id": "EX881e591abc3d4b29b9681e2a4d337f74",
                "type": "extensions"
            }
        },
        "notes": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC2489a08b3bba487799639b95c98f76ab/notes"
            }
        },
        "origin": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC2489a08b3bba487799639b95c98f76ab/origin"
            },
            "data": {
                "id": "RC2489a08b3bba487799639b95c98f76ab",
                "type": "rule_components"
            }
        },
        "property": {
            "links": {
                "related": "https://reactor.adobe.io/properties/PR28bc45fcba184e70b64b2f0cf7fe70f8"
            },
            "data": {
                "id": "PR28bc45fcba184e70b64b2f0cf7fe70f8",
                "type": "properties"
            }
        },
        "rules": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC2489a08b3bba487799639b95c98f76ab/rules"
            }
        }
    },
    "links": {
        "extension": "https://reactor.adobe.io/extensions/EX881e591abc3d4b29b9681e2a4d337f74",
        "origin": "https://reactor.adobe.io/rule_components/RC2489a08b3bba487799639b95c98f76ab",
        "rules": "https://reactor.adobe.io/rule_components/RC2489a08b3bba487799639b95c98f76ab/rules",
        "self": "https://reactor.adobe.io/rule_components/RC2489a08b3bba487799639b95c98f76ab"
    },
    "meta": {
        "latest_revision_number": 103
    }
}
