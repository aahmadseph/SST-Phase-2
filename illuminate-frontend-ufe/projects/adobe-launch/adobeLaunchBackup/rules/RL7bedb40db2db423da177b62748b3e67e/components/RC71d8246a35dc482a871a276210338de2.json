{
    "id": "RC71d8246a35dc482a871a276210338de2",
    "type": "rule_components",
    "attributes": {
        "created_at": "2023-08-03T20:19:12.568Z",
        "delegate_descriptor_id": "core::actions::custom-code",
        "deleted_at": null,
        "dirty": false,
        "name": "TAG: redditt_Purchase",
        "negate": false,
        "order": 1,
        "rule_order": 50,
        "timeout": 2000,
        "delay_next": false,
        "published": false,
        "published_at": null,
        "revision_number": 0,
        "updated_at": "2025-07-07T15:39:55.187Z",
        "created_by_email": "gustavo.rodriguez@sephora.com",
        "created_by_display_name": "Gustavo Rodriguez",
        "updated_by_email": "gustavo.rodriguez@sephora.com",
        "updated_by_display_name": "Gustavo Rodriguez",
        "settings": "{\"source\":\"var transactionValue = digitalData.transaction.total.transactionSubtotalInUSD;\\nvar transactionId = _satellite.getVar('[TMS] Page :: Order Number');\\nvar transactionItems = JSON.parse(_satellite.getVar('[TMS] GA4 :: Transaction :: Items')) || [];\\nvar products = [];\\n\\nvar eventID = \\\"purchase-\\\" + _satellite.getVar('[UEID] :: Universal Event ID Fx')(event);\\n_satellite.getVar('[TMS] Debug Log For QA Envs Fx')(`Reddit Event Debugger: ${eventID}`);\\n\\nif (digitalData.transaction \\u0026\\u0026 digitalData.transaction.item \\u0026\\u0026 Array.isArray(digitalData.transaction.item)) {\\n  digitalData.transaction.item.forEach(item =\\u003e {\\n    \\n    var productName = `${item.sku.productName || ''}`;\\n    var brand = `${item.sku?.brandName || ''}`;\\n    productName = brand !== '' ? `${productName} | ${brand}` : productName;\\n    \\n    products.push({\\n      \\\"id\\\": item.sku.skuId,\\n      \\\"name\\\": productName,\\n      \\\"category\\\": item.sku.parentCategory.displayName\\n    });\\n  });\\n}\\n\\nrdt('track', 'Purchase', {\\n  \\\"itemCount\\\": transactionItems.length,\\n  \\\"value\\\": transactionValue,\\n  \\\"currency\\\": 'USD',\\n  \\\"transactionId\\\": transactionId,\\n  \\\"products\\\": products,\\n  \\\"conversionId\\\": eventID\\n});\\n\\n\\n\\n// Custom events for selected Brands on Purchase event.\\n\\neventID = 123;\\ntransactionId = 12345;\\n\\nfunction ConvertAndFormat(valueToFormat) {\\n  // Formats the Price and Converts to USD when applicable.\\n  var om_value = valueToFormat || '';  \\n  om_value = om_value.replace(',', '.');\\n  om_value = om_value.replace('$', '');\\n  om_value = om_value.trim();\\n  om_value = Sephora.analytics.utils.convertToUSD(om_value);\\n  const valToReturn = Number(om_value);\\n  return isNaN(valToReturn) ? 0 : valToReturn;\\n}\\n\\nconst items = digitalData?.transaction?.item || [];\\n\\nconst selectedBrands = [\\n    'NARS',\\n    'The Ordinary',\\n    'Paulas Choice',\\n    'Armani',\\n    'Sephora Collection',\\n    'Crown Affair',\\n    'Tower 28',\\n    'Phlur'\\n];\\n\\nlet suffixIndex = 0;\\n\\n// Searches for each of the selected brands\\nfor (let i = 0; i \\u003c selectedBrands.length; i++) {\\n  const currentBrand = selectedBrands[i];\\n  const brandItems = items.filter(i =\\u003e (i?.sku?.brandName || '').toLowerCase() === currentBrand.toLowerCase());\\n  \\n  // Check if there are selected brand items\\n  if (brandItems.length \\u003e 0) {\\n    \\n    // Cleans up the Brand Name\\n    let selectedBrandName = currentBrand;\\n    selectedBrandName = selectedBrandName.replace(/ /g, ''); // Removes unwanted spaces.\\n    selectedBrandName = selectedBrandName.toLowerCase(); // Using same format as sotV07, all lower case.\\n\\n    let brandProductsToAdd = [];\\n    let brandProductsCount = 0;\\n    let brandProductTotalValue = 0;\\n\\n    // Formats the selected brand items and adds them to the array that will be sent on the pixel.\\n    for (let s = 0; s \\u003c brandItems.length; s++) {\\n      const brandItem = brandItems[s];\\n      brandProductsCount += (brandItem?.qty || 0);\\n      const currentBrandItemValue = ConvertAndFormat(brandItem?.listPriceSubtotal || 0);\\n      brandProductTotalValue += currentBrandItemValue;\\n      brandProductsToAdd.push({\\n        \\\"id\\\": brandItem?.sku.productId || '',\\n        \\\"name\\\": brandItem?.sku.productName || '',\\n        \\\"category\\\": brandItem?.sku.parentCategory.displayName || '',\\n        \\\"skuId\\\": brandItem?.sku?.skuId || '',\\n        \\\"productId\\\": brandItem?.sku.productId || '',\\n        \\\"brand\\\": brandItem?.sku?.brandName || '',\\n        \\\"qty\\\": brandItem?.qty || 0,\\n        \\\"value\\\": currentBrandItemValue || 0\\n      });\\n    }\\n    \\n    console.log(`AL Debug, Brand: ${currentBrand}, products to Add:`, brandProductsToAdd);\\n\\n    // Fires the custom event for the selected brand.\\n    rdt('track', 'custom', {\\n      \\\"customEventName\\\": `purchase_${selectedBrandName}`,\\n      \\\"conversionId\\\": eventID,\\n      \\\"itemCount\\\": brandProductsCount,\\n      \\\"value\\\": brandProductTotalValue,\\n      \\\"currency\\\": 'USD',\\n      \\\"transactionId\\\": `${transactionId}-${suffixIndex++}`, // Suffix for each brand.\\n      \\\"products\\\": brandProductsToAdd\\n    });\\n    \\n  }\\n}\\n\\n\\n\\n\\n\",\"language\":\"javascript\"}"
    },
    "relationships": {
        "updated_with_extension_package": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC71d8246a35dc482a871a276210338de2/updated_with_extension_package"
            },
            "data": {
                "id": "EP1fdd2a6ec2ae468fb1d2cac08df65f83",
                "type": "extension_packages"
            }
        },
        "updated_with_extension": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC71d8246a35dc482a871a276210338de2/updated_with_extension"
            },
            "data": {
                "id": "EX35ce3802460d499b9f4c856d69a764b4",
                "type": "extensions"
            }
        },
        "extension": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC71d8246a35dc482a871a276210338de2/extension"
            },
            "data": {
                "id": "EX881e591abc3d4b29b9681e2a4d337f74",
                "type": "extensions"
            }
        },
        "notes": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC71d8246a35dc482a871a276210338de2/notes"
            }
        },
        "origin": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC71d8246a35dc482a871a276210338de2/origin"
            },
            "data": {
                "id": "RC71d8246a35dc482a871a276210338de2",
                "type": "rule_components"
            }
        },
        "property": {
            "links": {
                "related": "https://reactor.adobe.io/properties/PR28bc45fcba184e70b64b2f0cf7fe70f8"
            },
            "data": {
                "id": "PR28bc45fcba184e70b64b2f0cf7fe70f8",
                "type": "properties"
            }
        },
        "rules": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RC71d8246a35dc482a871a276210338de2/rules"
            }
        }
    },
    "links": {
        "extension": "https://reactor.adobe.io/extensions/EX881e591abc3d4b29b9681e2a4d337f74",
        "origin": "https://reactor.adobe.io/rule_components/RC71d8246a35dc482a871a276210338de2",
        "rules": "https://reactor.adobe.io/rule_components/RC71d8246a35dc482a871a276210338de2/rules",
        "self": "https://reactor.adobe.io/rule_components/RC71d8246a35dc482a871a276210338de2"
    },
    "meta": {
        "latest_revision_number": 27
    }
}
