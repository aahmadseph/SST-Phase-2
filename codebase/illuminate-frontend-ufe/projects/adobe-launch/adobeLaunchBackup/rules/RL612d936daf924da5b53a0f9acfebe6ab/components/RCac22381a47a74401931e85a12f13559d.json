{
    "id": "RCac22381a47a74401931e85a12f13559d",
    "type": "rule_components",
    "attributes": {
        "created_at": "2022-11-07T15:00:39.490Z",
        "delegate_descriptor_id": "core::actions::custom-code",
        "deleted_at": null,
        "dirty": false,
        "name": "Core - Custom Code",
        "negate": false,
        "order": 1,
        "rule_order": 50,
        "timeout": 2000,
        "delay_next": true,
        "published": false,
        "published_at": null,
        "revision_number": 0,
        "updated_at": "2025-07-02T14:55:33.491Z",
        "created_by_email": "Ravinderreddy.Mandala@sephora.com",
        "created_by_display_name": "Ravinderreddy Mandala",
        "updated_by_email": "Aditya.Kumar@sephora.com",
        "updated_by_display_name": "Aditya Kumar",
        "settings": "{\"source\":\"(async function () {\\n  function readCookie(name) {\\n    //console.log(\\\"sot page view event for adobe\\\");\\n    var nameEQ = name + \\\"=\\\";\\n    var ca = document.cookie.split(\\\";\\\");\\n    for (var i = 0; i \\u003c ca.length; i++) {\\n      var c = ca[i];\\n      while (c.charAt(0) === \\\" \\\") c = c.substring(1, c.length);\\n      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);\\n    }\\n    return null;\\n  }\\n\\n  function setCookie(params) {\\n    var name = params.name,\\n      value = params.value,\\n      expireDays = params.days,\\n      expireHours = params.hours,\\n      expireMinutes = params.minutes,\\n      expireSeconds = params.seconds;\\n\\n    var expireDate = new Date();\\n    if (expireDays) {\\n      expireDate.setDate(expireDate.getDate() + expireDays);\\n    }\\n    if (expireHours) {\\n      expireDate.setHours(expireDate.getHours() + expireHours);\\n    }\\n    if (expireMinutes) {\\n      expireDate.setMinutes(expireDate.getMinutes() + expireMinutes);\\n    }\\n    if (expireSeconds) {\\n      expireDate.setSeconds(expireDate.getSeconds() + expireSeconds);\\n    }\\n    document.cookie =\\n      name +\\n      \\\"=\\\" +\\n      escape(value) +\\n      \\\";Secure\\\" +\\n      \\\";domain=sephora.com\\\" +\\n      \\\";path=/\\\" +\\n      \\\";expires=\\\" +\\n      expireDate.toUTCString();\\n  }\\n\\n  function deleteCookie(name) {\\n    setCookie({ name: name, value: \\\"\\\", seconds: 1 });\\n  }\\n\\n  function safelyReadProperty(attributePath, objectInfo) {\\n    return Sephora.analytics.utils.safelyReadProperty(\\n      attributePath,\\n      objectInfo\\n    );\\n  }\\n\\n  function getAdditionalSotVars() {\\n    var itemsByBasket = digitalData.cart.itemsByBasket || [];\\n    var skuIds = \\\"\\\",\\n      productIds = \\\"\\\",\\n      urls= \\\"\\\",\\n      cartCumulativeValue = 0,\\n      itemPrice = 0;\\n\\n    for (var i = 0; i \\u003c itemsByBasket.length; i++) {\\n\\n      var item = itemsByBasket[i].items;\\n      for (var j = 0; j \\u003c item.length; j++) {\\n        skuIds += item[j].sku.skuId + (item.length - 1 === j ? \\\"\\\" : \\\";\\\");\\n        productIds += (item[j].sku.productId || \\\"\\\") + (item.length - 1 === j ? \\\"\\\" : \\\";\\\");\\n        urls += (item[j].sku.url || \\\"\\\") + (item.length - 1 === j ? \\\"\\\" : \\\";\\\");\\n        if (item[j].salePriceSubtotal) {\\n          itemPrice = Number(item[j].salePriceSubtotal.slice(1));\\n        } else {\\n          itemPrice = Number(item[j].listPriceSubtotal.slice(1));\\n        }\\n        cartCumulativeValue += isNaN(itemPrice) ? 0 : itemPrice;\\n      }\\n      skuIds = skuIds + (i === itemsByBasket.length - 1 ? \\\"\\\" : \\\";\\\");\\n      productIds = productIds + (i === itemsByBasket.length - 1 ? \\\"\\\" : \\\";\\\");\\n      urls = urls + (i === itemsByBasket.length - 1 ? \\\"\\\" : \\\";\\\");\\n    }\\n\\n    return {\\n      sotV04: skuIds,\\n      sotV11: cartCumulativeValue,\\n      sotV15: productIds,\\n      sotV369: urls\\n      //sotV88: 'top bar basket icon click'\\n    };\\n  }\\n  function mergeObjects() {\\n    var resObject = {};\\n    for (var i = 0; i \\u003c arguments.length; i++) {\\n      var obj = arguments[i];\\n      var keys = obj ? Object.keys(obj) : [];\\n      for (var j = 0; j \\u003c keys.length; j++) {\\n        if (resObject[keys[j]]) {\\n          resObject[keys[j]] = mergeObjects(resObject[keys[j]], obj[keys[j]]);\\n        } else {\\n          resObject[keys[j]] = obj[keys[j]];\\n        }\\n      }\\n    }\\n    return resObject;\\n  }\\n\\n  function getProductNthLevelCategory() {\\n    if (digitalData.product \\u0026\\u0026 digitalData.product[0]) {\\n      return (\\n        (digitalData.product[0].attributes \\u0026\\u0026\\n          digitalData.product[0].attributes.nthLevelCategory) ||\\n        \\\"n/a\\\"\\n      );\\n    } else {\\n      return \\\"n/a\\\";\\n    }\\n  }\\n  function mergeSotVars(from, to) {\\n    if (from \\u0026\\u0026 from.sotVars \\u0026\\u0026 to \\u0026\\u0026 to.sotVars) {\\n      var fromKeys = Object.keys(from.sotVars);\\n      for (var i = 0; i \\u003c fromKeys.length; i++) {\\n        var fromKey = fromKeys[i];\\n        if (fromKey \\u0026\\u0026 !to.sotVars[fromKey]) {\\n          to.sotVars[fromKey] = from.sotVars[fromKey];\\n        }\\n      }\\n    }\\n    return to;\\n  }\\n  \\n  // SA-988\\n  function getWishListSkuIds() {\\n    let shoppingList = safelyReadProperty(\\\"Util.InflatorComps.services.UserInfo.data.shoppingList.shoppingListItems\\\", Sephora),\\n      wishList = [];\\n    if (shoppingList \\u0026\\u0026 shoppingList.length) {\\n      for (var i = 0; i \\u003c shoppingList.length; i++) {\\n        wishList.push(shoppingList[i].sku.skuId || '');\\n      }\\n    }\\n    return wishList.length ? wishList.join(\\\";\\\") : \\\"\\\";\\n  }\\n  \\n  //SA-1198\\n  function getProductIdforSotV15() {\\n    let sotV15 = \\\"\\\";\\n    if(digitalData) {\\n      if(digitalData.product \\u0026\\u0026 digitalData.product[0] \\u0026\\u0026 digitalData.product[0].productInfo \\u0026\\u0026 digitalData.product[0].productInfo.productID) {\\n        sotV15 = digitalData.product[0].productInfo.productID;\\n      } else if(digitalData.eventInfo \\u0026\\u0026 digitalData.eventInfo.attributes) {\\n        if(digitalData.eventInfo.attributes.productId) {\\n          sotV15 = digitalData.eventInfo.attributes.productId;\\n        } else if(digitalData.eventInfo.attributes.pageDetail) {\\n          sotV15 = digitalData.eventInfo.attributes.pageDetail;\\n        }\\n      }\\n    }\\n    return sotV15;\\n  }\\n  \\n  function getShippingMethod() {\\n    let sotV63 = \\\"\\\";\\n      if(digitalData \\u0026\\u0026 digitalData.product \\u0026\\u0026 digitalData.product[0] \\u0026\\u0026 digitalData.product[0].attributes \\u0026\\u0026 digitalData.product[0].attributes.type) {\\n        sotV63 = digitalData.product[0].attributes.type;\\n      }\\n      return sotV63.toLowerCase();\\n  }\\n  \\n   function getCustomerZipCode() {\\n    let sotV187 = \\\"\\\";\\n    if(digitalData \\u0026\\u0026 digitalData.page \\u0026\\u0026 digitalData.page.attributes \\u0026\\u0026 digitalData.page.attributes.customerZipCode) {\\n      sotV187 = digitalData.page.attributes.customerZipCode;\\n    }\\n    return sotV187;\\n  }\\n  \\n  function getStockAvailability(stockAvailability) {\\n    return stockAvailability === \\\"n/a\\\" ? 'Out of Stock' : (stockAvailability === \\\"Yes\\\" ? 'Limited Stock' : 'In Stock');\\n  }\\n  \\n  function getProductManufacturer() {\\n    let manufacturer = \\\"\\\";\\n    if(digitalData \\u0026\\u0026 digitalData.product \\u0026\\u0026 digitalData.product[0] \\u0026\\u0026 digitalData.product[0].productInfo \\u0026\\u0026 digitalData.product[0].productInfo.manufacturer) {\\n        manufacturer = digitalData.product[0].productInfo.manufacturer;\\n    }\\n    return manufacturer;\\n  }\\n  \\n  function getTotalNumberItems() {\\n     let totalCount = 0;\\n     let baskets = digitalData \\u0026\\u0026 digitalData.cart \\u0026\\u0026 digitalData.cart.itemsByBasket || [];\\n    baskets.forEach(basket =\\u003e {\\n        totalCount += basket.itemsCount;\\n    });\\n    return totalCount;\\n  }\\n  \\n  function getShoppingListCount() {\\n    let shoppingList = safelyReadProperty(\\\"Util.InflatorComps.services.UserInfo.data.shoppingList.shoppingListItems\\\", Sephora);\\n    let loveListObj = {\\n        totalItems: 0,\\n        inStockItems: 0,\\n        outOfStockItems: 0\\n    };\\n    if (shoppingList \\u0026\\u0026 shoppingList.length) {\\n        shoppingList.forEach(item =\\u003e {\\n            loveListObj.totalItems++;\\n            if (item?.sku?.isOutOfStock) {\\n                loveListObj.outOfStockItems++;\\n            } else {\\n                loveListObj.inStockItems++;\\n            }\\n        });\\n    }\\n    return loveListObj;\\n  }\\n  \\n  function updateAffiliateGateway() {\\n    let affiliateGateway = JSON.parse(localStorage.getItem(\\\"affiliateGatewayParameters\\\"));\\n    if(affiliateGateway?.data) {\\n      affiliateGateway.data.sotToRead = \\\"0\\\";\\n      localStorage.setItem(\\\"affiliateGatewayParameters\\\", JSON.stringify(affiliateGateway));\\n    } \\n  }\\n\\n  function updateRakutenOrderParams() {\\n    let rakutenOrderFlagSot = JSON.parse(localStorage.getItem(\\\"rakutenOrderNeedsToBeStoredBySot\\\"));\\n    if(rakutenOrderFlagSot?.data) {\\n      rakutenOrderFlagSot.data = false;\\n      localStorage.setItem(\\\"rakutenOrderNeedsToBeStoredBySot\\\", JSON.stringify(rakutenOrderFlagSot));\\n    }\\n  }\\n   \\n  try {\\n    //console.log(\\\"starting adobe launch pageview rule\\\");\\n    var heroslotBannerName;\\n    var heroslotBannerId;\\n    var heroslotBannerAlttext;\\n    var heroslotBannerTargetUrl;\\n    var unifiedImageBannerName;\\n    var unifiedImageBannerId;\\n    var unifiedImageBannerTargetUrl;\\n    var isPersonalizedBannerViewed;\\n\\n    if (digitalData.page.attributes.marketing) {\\n      var heroslot = digitalData.page.attributes.marketing.heroslot;\\n      var unifiedImage = digitalData.page.attributes.marketing.unifiedImage;\\n\\n      var heroslotBannerName = heroslot.banner.name\\n        ? heroslot.banner.name.join(\\\";\\\")\\n        : \\\"\\\";\\n      var heroslotBannerId = heroslot.banner.id\\n        ? heroslot.banner.id.join(\\\";\\\")\\n        : \\\"\\\";\\n      var heroslotBannerAlttext = heroslot.banner.alttext\\n        ? heroslot.banner.alttext.join(\\\";\\\")\\n        : \\\"\\\";\\n      var heroslotBannerTargetUrl = heroslot.banner.targetUrl\\n        ? heroslot.banner.targetUrl.join(\\\";\\\")\\n        : \\\"\\\";\\n      var unifiedImageBannerName = unifiedImage.banner.name\\n        ? unifiedImage.banner.name.join(\\\";\\\")\\n        : \\\"\\\";\\n      var unifiedImageBannerId = unifiedImage.banner.id\\n        ? unifiedImage.banner.id.join(\\\";\\\")\\n        : \\\"\\\";\\n      var unifiedImageBannerTargetUrl = unifiedImage.banner.targetUrl\\n        ? unifiedImage.banner.targetUrl.join(\\\";\\\")\\n        : \\\"\\\";\\n      if (heroslotBannerName || unifiedImageBannerName) {\\n        isPersonalizedBannerViewed = true;\\n      }\\n    }\\n\\n    function formatSotType(sotType) {\\n      return sotType \\u0026\\u0026 sotType.toLowerCase().replace(/([\\\\:\\\\-])/g, \\\" \\\");\\n    }\\n    \\n    function getValidLinkName(sotType) {\\n        if(typeof sotType === \\\"undefined\\\" || sotType === null || sotType === \\\"null\\\") {\\n          return false;\\n        } \\n        return true;\\n      }\\n\\n    var languageLocale = safelyReadProperty(\\n      \\\"page.attributes.languageLocale\\\",\\n      digitalData\\n    )?.toLowerCase()?.slice(-2);\\n    var pageTitle = digitalData.page.attributes.sephoraPageInfo.pageName;\\n    var biAccountId = digitalData.user[0].segment.biAccountId;\\n    var profileId = digitalData.user[0].profile[0].profileInfo.profileID;\\n    var biStatus = digitalData.user[0].segment.biStatus;\\n    var biPoints = digitalData.user[0].segment.biPoints;\\n    var platform = digitalData.page.attributes.platform;\\n    var emailId = digitalData.user[0].profile[0].profileInfo.email;\\n    var referrerCode = digitalData.page.attributes.campaigns.marketingChannel;\\n    var signInStatus = digitalData.user[0].segment.signInStatus;\\n    var timestamp = new Date().getTime();\\n    var ipAddress = await _satellite.getVar(\\\"[SOT] System :: IP Address\\\");\\n    var linkName;\\n    //var digitalDataTimestamp = digitalData.page.attributes.date.timestamp;\\n    var sotSubType = digitalData.page.category.pageType;\\n    var viewCategories = [\\\"categorylevel\\\", \\\"nthlevel\\\", \\\"toplevel\\\", \\\"category\\\", \\\"contentstore\\\", \\\"brand\\\"];\\n    var isotViewCategory = viewCategories.indexOf(sotSubType) \\u003e -1;\\n    var currency = digitalData.page.pageInfo.country === \\\"US\\\" ? \\\"USD\\\" : \\\"CAD\\\";\\n    var cartInfo = getAdditionalSotVars();\\n    cartInfo[\\\"sotV63\\\"] = _satellite.getVar(\\\"[TMS] Basket :: Shipment Methods\\\");\\n\\n    // var eventId;\\n    // var uniqueId = digitalData.page.attributes.uniqueId;\\n    // var digitalDataTimestamp = digitalData.page.attributes.date.timestamp;\\n    // if (uniqueId + timestamp) {\\n    //   eventId = uniqueId + timestamp;\\n    // } else if (profileId \\u0026\\u0026 timestamp) {\\n    //   eventId = profileId + timestamp;\\n    // } else if (digitalData.anonymousUserId \\u0026\\u0026 timestamp) {\\n    //   eventId = digitalData.anonymousUserId + timestamp;\\n    // }\\n    var set14OnwardsEvents = [\\n      // Set 14 events\\n      \\\"view product page from chat\\\",\\n      \\\"personalized banner impression\\\",\\n    ];\\n\\n    var pageTypeDetail = safelyReadProperty(\\n      \\\"page.pageInfo.pageName\\\",\\n      digitalData\\n    ).toLowerCase();\\n    var pageWorld = (digitalData.page.attributes.world || \\\"n/a\\\").toLowerCase();\\n    var pageNameInCode = \\\"D=pageName\\\";\\n    var sotCategory = digitalData.page.category.primaryCategory || \\\"none\\\";\\n    var sotSubCategory = getProductNthLevelCategory();\\n    var skuIds;\\n    let skuPrice = \\\"\\\";\\n    if(digitalData \\u0026\\u0026 digitalData.product \\u0026\\u0026 digitalData.product[0] \\u0026\\u0026 digitalData.product[0].attributes \\u0026\\u0026 digitalData.product[0].attributes.price) {\\n      skuPrice = digitalData.product[0].attributes.price;\\n    }\\n    var skuBrand = getProductManufacturer() || \\\"none\\\";\\n    \\n    if (\\n      sotSubType === \\\"categorylevel\\\" ||\\n      sotSubType === \\\"nthlevel\\\" ||\\n      sotSubType === \\\"toplevel\\\" ||\\n      sotSubType === \\\"category\\\"\\n    ) {\\n      skuIds = digitalData.page.category.fbProductSkus.reduce(function (\\n        skuId,\\n        item,\\n        idx\\n      ) {\\n        return idx === 0 ? item : skuId + \\\";\\\" + item;\\n      },\\n      \\\"\\\");\\n    } else if (sotSubType === \\\"product\\\") {\\n      skuIds = digitalData \\u0026\\u0026 digitalData.product \\u0026\\u0026 digitalData.product[0] \\u0026\\u0026 digitalData.product[0].attributes \\u0026\\u0026 digitalData.product[0].attributes.skuId || \\\"\\\";\\n    } else if (sotSubType === \\\"basket\\\") {\\n      skuIds = cartInfo.sotV04 || \\\"\\\";\\n    } else {\\n      let basketSkuIds = (digitalData \\u0026\\u0026 digitalData.cart \\u0026\\u0026 digitalData.cart.attributes \\u0026\\u0026 digitalData.cart.attributes.skuIds) ? digitalData.cart.attributes.skuIds.join(\\\";\\\"): [];\\n      skuIds = basketSkuIds || _satellite.getVar(\\n        \\\"[TMS] Pixel :: Facebook :: Stringified Sku Array - pageLoadEvent\\\"\\n      );\\n    }\\n    \\n    //XSEL-4261\\n    if(pageTypeDetail === \\\"beauty-offers\\\") {\\n      pageTypeDetail = \\\"beauty offers\\\";\\n      sotSubType = \\\"offers\\\";\\n      pageTitle = \\\"offers:beauty offers:n/a:*\\\";\\n    }\\n\\n    if (pageTypeDetail === \\\"creatorstorefront\\\") {\\n        pageTypeDetail = digitalData?.page?.category?.pageType;\\n        sotSubType = \\\"store front view\\\";\\n    }\\n\\n    var fbpValue = readCookie(\\\"_fbp\\\");\\n    var fbcValue = readCookie(\\\"_fbc\\\");\\n    var sc_click_id = sessionStorage.getItem(\\\"sc_click_id\\\");\\n    //console.log(fbcValue, \\\"sot page fbc cookie adobe\\\");\\n    var scidValue = readCookie(\\\"_scid\\\");\\n    var ccpaConsentCookie = readCookie(\\\"ccpaConsentCookie\\\") === '1' ? 1 : 0;\\n\\n    var sduProps = safelyReadProperty(\\n      \\\"profile.userSubscriptions\\\",\\n      Sephora.Util.getUserInfoCache() || \\\"\\\"\\n    );\\n    var isTrialEligibleSdu = sduProps \\u0026\\u0026 sduProps[0].isTrialEligible;\\n    var statusSdu = sduProps \\u0026\\u0026 sduProps[0].status;\\n    var typeSdu = sduProps \\u0026\\u0026 sduProps[0].type;\\n\\n    var additionalDataToSend = {\\n      campaign: {\\n        referrerCode: referrerCode,\\n      },\\n      sysInfo: {\\n        userLanguage: languageLocale,\\n        ipAddress: ipAddress,\\n      },\\n      pageInfo: {\\n        title: pageTitle,\\n      },\\n      session: {\\n        biId: biAccountId,\\n        biTier: biStatus,\\n        biPoints: biPoints,\\n        profileId: profileId,\\n        platform: platform,\\n        emailId: emailId,\\n        signInState: signInStatus,\\n        atgId: _satellite.getVar(\\n          \\\"[TMS] Async :: User :: ATG ID - page load or async page load\\\"\\n        ),\\n        timestamp: timestamp,\\n      },\\n      eventTime: timestamp,\\n      eventId: _satellite.getVar(\\\"[UEID] :: Universal Event ID Fx\\\")(event) || _satellite.getVar(\\\"[TMS] :: Event Id\\\"),\\n      sotVars: {},\\n      sotProps: {\\n        sot20: timestamp + \\\"\\\",\\n      },\\n    };\\n    if (\\n      digitalData.page.category.sponsoredProducts \\u0026\\u0026\\n      digitalData.page.category.sponsoredProducts.length \\u003e 0\\n    ) {\\n      var impressionIds = digitalData.page.category.sponsoredProducts.map(\\n        function (value) {\\n          return value.impressionTrackerId + \\\";\\\" + value.impressionPayload;\\n        }\\n      );\\n      impressionIds = impressionIds \\u0026\\u0026 impressionIds.toString();\\n    }\\n    var atTokens =\\n      digitalData.page.attributes \\u0026\\u0026\\n      digitalData.page.attributes.adobeTargetResponseTokens;\\n    var activityId, activityName, experienceId, experienceName, visitorId;\\n    if (atTokens \\u0026\\u0026 atTokens.length \\u003e 0) {\\n      activityId = atTokens[0][\\\"activity.id\\\"];\\n      activityName = atTokens[0][\\\"activity.name\\\"];\\n      experienceId = atTokens[0][\\\"experience.id\\\"];\\n      experienceName = atTokens[0][\\\"experience.name\\\"];\\n      visitorId = atTokens[0][\\\"profile.marketingCloudVisitorId\\\"];\\n    }\\n\\n    let sotV56Val = _satellite.getVar(\\\"[TMS] Product String :: On-load\\\");\\n    if (sotV56Val \\u0026\\u0026 sotV56Val.length === 0) {\\n      sotV56Val = null;\\n    }\\n    //SA-811\\n    let sotV10Val = null;\\n    let sotV251Val = null;\\n    \\n    if(digitalData.transaction){\\n      if(digitalData.transaction.originalOrderID) {\\n      sotV10Val = digitalData.transaction.originalOrderID;\\n      }\\n      if(digitalData.transaction.replacementOrderID) {\\n        sotV251Val = digitalData.transaction.replacementOrderID;\\n      }\\n    }\\n    \\n    //SA-1324\\n    let sotV238Val = null;\\n    let sotV246Val = null;\\n    if(digitalData \\u0026\\u0026 digitalData.page \\u0026\\u0026 digitalData.page.attributes \\u0026\\u0026 digitalData.page.attributes.date) {\\n      sotV238Val = digitalData.page.attributes.date.timeZone ? digitalData.page.attributes.date.timeZone : \\\"\\\";\\n      sotV246Val = digitalData.page.attributes.date.timeZoneName ? digitalData.page.attributes.date.timeZoneName : \\\"\\\";\\n    }\\n    \\n    //SA-2376\\n    let sotV181Val = \\\"\\\";\\n    let webURL = window?.location?.href || \\\"\\\";\\n    if (webURL \\u0026\\u0026 webURL.includes(\\\"deep_link=true\\\")) {\\n        sotV181Val = webURL;\\n    }\\n\\n    let epikLS = JSON.parse(window.localStorage.getItem(\\\"_epik_ls\\\"));\\n    let epikLSValid = epikLS?.expires \\u0026\\u0026 epikLS?.value \\u0026\\u0026 !isNaN(new Date(epikLS.expires)) \\u0026\\u0026 new Date(epikLS.expires) \\u003e= new Date();\\n    let epikId = new URL(window.location.href).searchParams.get(\\\"epik\\\") || _satellite.cookie.get('_epik') || (epikLSValid \\u0026\\u0026 epikLS.value) || \\\"\\\";\\n\\n    const utmParameters = JSON.parse(window.localStorage.getItem(\\\"utmParameters\\\"));\\n    const allowUtm = utmParameters?.expiration \\u003e= new Date().getTime() ? true : \\\"\\\";\\n    const {\\n      utm_id,\\n      utm_source,\\n      utm_medium,\\n      utm_campaign,\\n      utm_source_platform,\\n      utm_term,\\n      utm_content,\\n      utm_creative_format,\\n      utm_marketing_tactic\\n    } = allowUtm ? utmParameters : {};\\n    const lowerCaseParams = new URLSearchParams(\\n      Array.from(new URLSearchParams(new URL(window.location.href).search), ([key, value]) =\\u003e [key.toLowerCase(), value])\\n    );\\n    const rdtCidURL = lowerCaseParams.get('rdt_cid');\\n    rdtCidURL \\u0026\\u0026 sessionStorage.setItem('rdt_cid', rdtCidURL);\\n    \\n    var dataToSend = {\\n      sotVars: {\\n        sotSubType: sotSubType,\\n        sotCategory: sotCategory,\\n        sotSubCategory: sotSubCategory,\\n        sotV01: pageTypeDetail,\\n        sotV02: pageWorld,\\n        sotV03: pageNameInCode,\\n        sotV04: skuIds,\\n        sotV06: skuPrice,\\n        sotV07: skuBrand,\\n        sotV09: currency,\\n        sotV10: sotV10Val,\\n        sotV11: cartInfo.sotV11,\\n        sotV12: fbpValue,\\n        sotV232: fbcValue,\\n        sotV13: ccpaConsentCookie,\\n        //Adobe variables\\n        sotV52: _satellite.getVar(\\\"[TMS] SiteCatalyst :: Account ID\\\"),\\n        sotV53: _satellite.getVar(\\\"[TMS] Channel\\\"),\\n        sotV54: _satellite.getVar(\\\"[TMS] Campaign :: URS :: Channel\\\"),\\n        sotV55: _satellite.getVar(\\\"[TMS] Page :: Event Strings\\\"),\\n        sotV56: sotV56Val,\\n        sotV57: _satellite.getVar(\\\"[TMS] Transaction :: ISO :: Currency\\\"),\\n        sotV58: _satellite.getVar(\\\"[TMS] Page :: Certona Impression\\\"),\\n        sotV59: _satellite.getVar(\\\"[TMS] Page :: Order Number\\\"),\\n        sotV60: _satellite.getVar(\\\"[TMS] Page :: Search :: Search Term\\\"),\\n        sotV61: _satellite.getVar(\\\"[TMS] Internal Campaign\\\"),\\n        sotV62: _satellite.getVar(\\n          \\\"[TMS] Page :: Page Name for eVar6 - pageLoadEvent\\\"\\n        ),\\n        sotV63: _satellite.getVar(\\\"[TMS] Page :: Order :: Shipping Method\\\") || cartInfo.sotV63,\\n        sotV64: _satellite.getVar(\\\"[TMS] Page :: Order :: Payment Method\\\"),\\n        sotV65: _satellite.getVar(\\\"[TMS] Page :: Promo Code\\\"),\\n        sotV66: \\\"D=c27\\\",\\n        sotV67: \\\"D=c9\\\",\\n        sotV68: _satellite.getVar(\\\"[TMS] Page :: Experience\\\"),\\n        sotV69: _satellite.getVar(\\\"[TMS] Page :: Order Number\\\"),\\n        sotV70: _satellite.getVar(\\\"[TMS] Page :: Certona Audience Id\\\"),\\n        sotV71: _satellite.getVar(\\\"[TMS] Campaign :: Affiliate ID\\\"),\\n        sotV72: _satellite.getVar(\\\"[TMS] Page :: Audience Segmentation\\\"),\\n        sotV73: _satellite.getVar(\\\"[TMS] Page :: Day of Week\\\"),\\n        sotV74: \\\"D=g\\\",\\n        sotV75: _satellite.getVar(\\\"[TMS] Page :: Search Type - asyncPageLoad\\\"),\\n        sotV76: _satellite.getVar(\\\"[TMS] Campaign :: URS :: Channel\\\"),\\n        sotV77: \\\"adobe triggered\\\",\\n        sotV78: _satellite.getVar(\\n          \\\"[TMS] Campaign :: Email Harmony Deployment Id\\\"\\n        ),\\n        sotV79: _satellite.getVar(\\\"[TMS] Campaign :: Harmony Link ID\\\"),\\n        sotV80: _satellite.getVar(\\\"[TMS] Campaign :: Harmony Customer Key\\\"),\\n        sotV81: _satellite.getVar(\\\"[TMS] Campaign : Email ATG ID\\\"),\\n        sotV82: \\\"D=c6\\\",\\n        sotV83: \\\"D=c8\\\",\\n        sotV84: _satellite.getVar(\\\"[TMS] Category Filters\\\"),\\n        sotV85: \\\"D=User-Agent\\\",\\n        sotV86: \\\"D=c9\\\",\\n        sotV87: \\\"D=g\\\",\\n        sotV88: _satellite.getVar(\\n          \\\"[TMS] Page :: Previous Navigation Information\\\"\\n        ),\\n        sotV89: _satellite.getVar(\\\"[TMS] Page :: Search Term Dynamic Var\\\"),\\n        sotV90: _satellite.getVar(\\\"[TMS] User :: BIFlash\\\"),\\n        sotV91: _satellite.getVar(\\\"[TMS] Internal Campaign\\\"),\\n        sotV92: null, // _satellite.getVar('[TMS] AdBanner'), // TODO: need to create, not even in signal\\n        sotV93: _satellite.getVar(\\\"[TMS] Page :: Beauty Talk Navigation Info\\\"),\\n        sotV94: _satellite.getVar(\\\"[TMS] Campaign :: Bluecore Campaign ID\\\"),\\n        sotV95: _satellite.getVar(\\\"[TMS] Page :: Is Apple Pay Eligible\\\"),\\n        sotV96: _satellite.getVar(\\\"[TMS] Campaign :: Epsilon Audience ID\\\"),\\n        sotV97: _satellite.getVar(\\\"[TMS] Page :: ATG Version\\\"),\\n        sotV98: _satellite.getVar(\\n          \\\"[TMS] Page :: Experience Store ID - pageLoadEvent\\\"\\n        ),\\n        sotV99: _satellite.getVar(\\\"[TMS] Page :: biChipType\\\"),\\n        sotV100: _satellite.getVar(\\\"[TMS] Page :: Search Results Algorithm Type\\\"),\\n        sotV101: _satellite.getVar(\\\"[TMS] Page :: Certona Audience Id\\\"),\\n        sotV102: _satellite.getVar(\\\"[TMS] Page :: BreakPoint\\\"),\\n        sotV103: _satellite.getVar(\\\"[TMS] Page :: Experience Type\\\"),\\n        sotV104: _satellite.getVar(\\\"[TMS] Page :: Search Term\\\"),\\n        sotV105: _satellite.getVar(\\n          \\\"[TMS] Page :: Number of Results - pageLoadEvent\\\"\\n        ),\\n        sotV106: _satellite.getVar(\\\"[TMS] Page :: Previous Page Name\\\"),\\n        sotV107: _satellite.getVar(\\\"[TMS] Page :: Previous Page Type\\\"),\\n        sotV108: _satellite.getVar(\\n          \\\"[TMS] Page :: Certona Placement :: ProductPage Tracking\\\"\\n        ),\\n        sotV109: _satellite.getVar(\\\"[TMS] Page :: Content Country\\\"),\\n        sotV110: _satellite.getVar(\\\"[TMS] Page :: Date\\\"),\\n        sotV111: _satellite.getVar(\\\"[TMS] User :: Accepted Advertising Cookies\\\"),\\n        sotV112: _satellite.getVar(\\\"[TMS] Page :: Community User Id\\\"),\\n        sotV113: \\\"D=v62\\\",\\n        sotV114: _satellite.getVar(\\\"[TMS] Event :: Last Refresh\\\"),\\n        sotV115: _satellite.getVar(\\\"[TMS] User :: Play Status\\\"),\\n        sotV116: _satellite.getVar(\\\"[TMS] Page :: Previous Link Data\\\"),\\n        sotV117: _satellite.getVar(\\\"[TMS] Page :: Variant Keys\\\"),\\n        sotV118: _satellite.getVar(\\\"[TMS] Dynamic Category Filter\\\"),\\n        sotV119: _satellite.getVar(\\\"[TMS] Page :: Country\\\"),\\n        sotV120: null, // _satellite.getVar('[TMS] adBannersOn'), // TODO: need to create'[[adBannersOn]]',\\n        sotV181: sotV181Val,\\n        sotV202: activityId,\\n        sotV203: activityName,\\n        sotV204: experienceId,\\n        sotV205: experienceName,\\n        sotV206: visitorId,\\n        sotV207: heroslotBannerName,\\n        sotV208: heroslotBannerId,\\n        sotV209: heroslotBannerAlttext,\\n        sotV210: heroslotBannerTargetUrl,\\n        sotV211: unifiedImageBannerName,\\n        sotV212: unifiedImageBannerId,\\n        sotV213: unifiedImageBannerTargetUrl,\\n        sotV222: isTrialEligibleSdu,\\n        sotV223: statusSdu,\\n        sotV224: typeSdu,\\n        sotV227: scidValue,\\n        sotV225: \\\"AL\\\",\\n        sotV226: false,\\n        sotV238: sotV238Val,\\n        sotV246: sotV246Val,\\n        sotV251: sotV251Val,\\n        sotV254: cartInfo.sotV04 || \\\"n/a\\\",\\n        sotV259: getWishListSkuIds(),\\n        sotV295: sc_click_id,\\n        sotV302: _satellite.readCookie('ttclid') || \\\"\\\",\\n        sotV303: _satellite.readCookie('_ttp') || \\\"\\\",\\n        sotV324: new URL(window.location.href).searchParams.get(\\\"gclid\\\"),\\n        sotV325: epikId,\\n        sotV278: _satellite.readCookie('referrer') || \\\"\\\",\\n        sotV327: _satellite.getVar(\\\"[SOT] :: Forter Token\\\") || \\\"\\\",\\n        sotV341: _satellite.getVar(\\\"[SOT] :: URL Navigation History\\\") || \\\"\\\",\\n        sotV349: utm_id,\\n        sotV350: utm_source,\\n        sotV351: utm_medium,\\n        sotV352: utm_campaign,\\n        sotV353: utm_source_platform,\\n        sotV354: utm_term,\\n        sotV355: utm_content,\\n        sotV356: utm_creative_format,\\n        sotV357: utm_marketing_tactic,\\n        sotV361: sessionStorage.getItem('rdt_cid'),\\n        sotV362: _satellite.readCookie('_rdt_uuid') || \\\"\\\",\\n        sotV365: profileId \\u0026\\u0026 await Sephora?.analytics?.utils?.hashString(profileId),\\n        sotV366: biAccountId \\u0026\\u0026 await Sephora?.analytics?.utils?.hashString(biAccountId),\\n        sotV369: cartInfo.sotV369,\\n        sotV399: _satellite.getVar(\\\"[SOT] Page :: event_date_PST\\\"),\\n        sotV406: digitalData?.csfPayload?.anchor_post_unique_key || '',\\n        sotV407: digitalData?.csfPayload?.anchor_collection_unique_key || '',\\n        sotV408: digitalData?.csfPayload?.motom_user_id || '',\\n        sotV409: digitalData?.csfPayload?.traffic_source || '',\\n      },\\n      sotProps: {\\n        sot20: timestamp + \\\"\\\",\\n      },\\n    };\\n\\n    // ORCH-2245\\n    if (sotSubType === 'product') {\\n      var profileId = digitalData?.user[0]?.profile[0]?.profileInfo?.profileID || '';\\n      var biAccountId = Sephora.Util.getUserInfoCache()?.profile?.beautyInsiderAccount?.biAccountId || '';\\n\\n      // Formats the Price.\\n      var om_price = digitalData.product[0].attributes.price || '';\\n      om_price = om_price.replace(',', '.');\\n      om_price = om_price.replace('$', '');\\n      om_price = om_price.trim();\\n\\n      var om_original_price = digitalData.product[0].attributes.price || '';\\n      om_original_price = om_original_price.replace(',', '.');\\n      om_original_price = om_original_price.replace('$', '');\\n      om_original_price = om_original_price.trim();\\n\\n      var productData = digitalData?.product[0];\\n\\n      if (productData) {\\n        const getLastNestedId = (obj, keyField, childKey) =\\u003e {\\n          const id = obj[keyField];\\n          if (obj[childKey] === undefined) {\\n            return id;\\n          }\\n          return getLastNestedId(obj[childKey], keyField, childKey);\\n        };\\n\\n        var productId = digitalData.product[0].productInfo.productID || '';\\n        var om_is_new = productData?.attributes?.isNew === undefined ? false : productData?.attributes?.isNew;\\n        var om_out_of_stock = productData?.attributes?.isOutOfStock === undefined ? false : productData?.attributes?.isOutOfStock;\\n        var om_is_limited_edition = productData?.attributes?.isLimitedEdition === undefined ? false : productData?.attributes?.isLimitedEdition;\\n        var om_is_app_exclusive = productData?.attributes?.isAppExclusive === undefined ? false : productData?.attributes?.isAppExclusive;\\n\\n        // Key Identifying the department or highest level of category.\\n        var on_department = getLastNestedId(productData?.attributes?.parentCategory || {}, 'categoryId', 'parentCategory');\\n\\n        var parameters = {\\n          sotV367: Number(om_price || ''),\\n          sotV368: productData?.attributes?.image || '',\\n          sotV369: productData?.attributes?.productUrl || '',\\n          sotV370: productData?.attributes?.isBiReward,\\n          sotV371: productData?.attributes?.parentCategory?.displayName || '',\\n          sotV372: productData?.attributes?.parentCategory?.categoryId || '',\\n          sotV373: productData?.attributes?.nthLevelCategoryId || '',\\n          sotV374: productData?.attributes?.rating || 0,\\n          sotV375: productData?.attributes?.rating || 0,\\n          sotV376: productData?.attributes?.variationType || '',\\n          sotV377: productData?.attributes?.suggestedUsage || '', // New\\n          sotV378: om_is_app_exclusive,\\n          sotV379: om_is_limited_edition,\\n          sotV380: om_is_new,\\n          sotV381: om_is_new,\\n          sotV382: productData?.attributes?.reviews || 0, // New\\n          sotV383: productData?.attributes?.lovesCount || 0, // New\\n          sotV384: productData?.productInfo?.description || '',\\n          sotV385: on_department || ''          \\n          // --- N/A parameters... ---\\n          // \\\"bluecore_parent_id\\\":,\\n          // \\\"is_bluecore_parent\\\":,\\n          // \\\"has_refill_variant\\\": \\\"\\\",\\n          // \\\"is_refill_variant\\\": \\\"\\\",\\n          // \\\"is_mini\\\": \\\"\\\",\\n          // \\\"ca_on_sale\\\": \\\"\\\",\\n          // \\\"ca_klarna_pricing\\\": \\\"\\\",\\n          // \\\"ca_has_bis_signup_button\\\": \\\"\\\",\\n        };\\n\\n        if (Sephora.renderQueryParams.country === 'CA') {\\n          parameters = {\\n            ...parameters,\\n            // Canada (EN/FR) Only Parameters...\\n            sotV386: Number(om_price || ''),\\n            sotV387: Number(om_original_price || ''),\\n            sotV388: om_out_of_stock,\\n            sotV389: productData?.attributes?.isSephoraExclusive\\n          }\\n        }\\n\\n        if (Sephora.renderQueryParams.language === 'fr') {\\n          parameters = {\\n            ...parameters,\\n            // Canada (FR) Only Parameters...\\n            sotV390: productData?.productInfo?.productName || '',\\n            sotV391: productData?.attributes?.nthLevelCategory || '',\\n            sotV392: productData?.attributes?.image || '',\\n            sotV393: productData?.attributes?.suggestedUsage || '' // New\\n          }\\n        }\\n        dataToSend.sotVars = {\\n          ...dataToSend.sotVars, ...parameters\\n        }\\n      }\\n    }\\n\\n    var sotV55 = dataToSend.sotVars.sotV55;\\n    var pPageProdView = sotV55.split(\\\",\\\").indexOf(\\\"event200\\\") != -1;\\n    var productID = pPageProdView ? getProductIdforSotV15() : \\\"\\\";\\n    var isSearchEvent =\\n      sotV55 \\u0026\\u0026 sotV55.split(\\\",\\\").indexOf(\\\"event1\\\") != -1 \\u0026\\u0026 dataToSend.sotVars.sotV104;\\n    var isTierVibMigration =\\n      sotV55 \\u0026\\u0026 sotV55.split(\\\",\\\").indexOf(\\\"event236\\\") != -1;\\n    var isTierRougeMigration =\\n      sotV55 \\u0026\\u0026 sotV55.split(\\\",\\\").indexOf(\\\"event237\\\") != -1;\\n    var isLogoutEvent =\\n      safelyReadProperty(\\\"sotVars.sotV88\\\", dataToSend).indexOf(\\n        \\\"sign out:sign out:sign out\\\"\\n      ) != -1; // dataToSend.sotVars.sotV88.indexOf('sign out:sign out:sign out') != -1;\\n    var storeLocator =\\n      safelyReadProperty(\\\"sotVars.sotV01\\\", dataToSend).indexOf(\\\"store locator\\\") !=\\n      -1;\\n    var listsLoves =\\n      safelyReadProperty(\\\"sotVars.sotV88\\\", dataToSend).indexOf(\\n        \\\"top nav:loves icon:loves icon:loves icon:loves icon\\\"\\n      ) != -1;\\n    var continueShopping =\\n      safelyReadProperty(\\\"sotVars.sotV116\\\", dataToSend).indexOf(\\n        \\\"order confirmation:continue shopping\\\"\\n      ) != -1;\\n    var happeningAtSephora =\\n      safelyReadProperty(\\\"sotVars.sotV88\\\", dataToSend).indexOf(\\n        \\\"top nav:stores:stores events:stores events:stores events\\\"\\n      ) != -1;\\n    var beautyServiceFaq =\\n      safelyReadProperty(\\\"sotVars.sotV01\\\", dataToSend).indexOf(\\n        \\\"beauty services faq\\\"\\n      ) != -1;\\n    var answerIntent =\\n      safelyReadProperty(\\\"sotVars.sotV01\\\", dataToSend).indexOf(\\\"answer-intent\\\") !=\\n      -1;\\n    var isChatRedirect = location.href.split(\\\"utm_source=\\\")[1] === \\\"insidechat\\\";\\n    var questionAsk =\\n      safelyReadProperty(\\\"sotVars.sotV01\\\", dataToSend).indexOf(\\\"question-ask\\\") !=\\n      -1;\\n    var beautyInsider =\\n      safelyReadProperty(\\\"sotVars.sotV88\\\", dataToSend).indexOf(\\n        \\\"top nav:account:beauty insider:beauty insider:beauty insider\\\"\\n      ) != -1;\\n    var myCmntyProfile =\\n      safelyReadProperty(\\\"sotVars.sotV01\\\", dataToSend).indexOf(\\\"my-profile\\\") !=\\n      -1;\\n    var creditCardProgram =\\n      safelyReadProperty(\\\"sotVars.sotV88\\\", dataToSend).indexOf(\\n        \\\"top nav:account:credit card section join:credit card section join:credit card section join\\\"\\n      ) != -1;\\n    var bookAServiceLanding =\\n      safelyReadProperty(\\\"sotVars.sotV01\\\", dataToSend).indexOf(\\n        \\\"book a service-landing\\\"\\n      ) != -1;\\n    var bookAServiceConfirmation =\\n      safelyReadProperty(\\\"sotVars.sotV01\\\", dataToSend).indexOf(\\n        \\\"book a service-confirmation\\\"\\n      ) != -1;\\n    var applyPercentageOff =\\n      safelyReadProperty(\\\"sotVars.sotV116\\\", dataToSend).indexOf(\\n        \\\"bi:points for discount:apply in basket\\\"\\n      ) != -1;\\n    var applyCashDiscount =\\n      safelyReadProperty(\\\"sotVars.sotV116\\\", dataToSend).indexOf(\\n        \\\"bi:beauty insider cash:apply in basket\\\"\\n      ) != -1;\\n    var followersPageView =\\n      safelyReadProperty(\\\"sotVars.sotV106\\\", dataToSend).indexOf(\\n        \\\"cmnty profile:my-profile:n/a:*followers[\\\"\\n      ) != -1;\\n\\n    var url_string = window.location.href;\\n    var url = new URL(url_string);\\n    var productId = url.searchParams.get(\\\"productId\\\");\\n    var questionId = url.searchParams.get(\\\"questionId\\\");\\n    var previousPage = digitalData.page.attributes.previousPageData.linkData;\\n\\n    var additionalDataPayload = {\\n      sysInfo: {\\n        userLanguage: languageLocale,\\n        ipAddress: ipAddress,\\n      },\\n      pageInfo: {\\n        title: pageTitle,\\n      },\\n      eventTime: timestamp,\\n      eventId: _satellite.getVar(\\\"[UEID] :: Universal Event ID Fx\\\")(event) || _satellite.getVar(\\\"[TMS] :: Event Id\\\"),\\n      session: {\\n        biId: biAccountId,\\n        biTier: biStatus,\\n        biPoints: biPoints,\\n        profileId: profileId,\\n        platform: platform,\\n        emailId: emailId,\\n        signInState: signInStatus,\\n        atgId: _satellite.getVar(\\n          \\\"[TMS] Async :: User :: ATG ID - page load or async page load\\\"\\n        ),\\n        timestamp: timestamp,\\n      },\\n      sotProps: {\\n        sot20: timestamp + \\\"\\\",\\n      },\\n      sotVars: {\\n        sotV15: getProductIdforSotV15() || productID,\\n      },\\n    };\\n\\n    if (isSearchEvent) {\\n      linkName = \\\"Search\\\";\\n    } else if (isLogoutEvent) {\\n      linkName = \\\"Logout\\\";\\n    } else if (isTierVibMigration) {\\n      linkName = \\\"Tier VIB\\\";\\n    } else if (isTierRougeMigration) {\\n      linkName = \\\"Tier Rouge\\\";\\n    } else if (isChatRedirect) {\\n      linkName = \\\"view product page from chat\\\";\\n    } else if (storeLocator) {\\n      linkName = \\\"page view\\\";\\n      additionalDataPayload.sotVars = {\\n        sotV88: \\\"happening at sephora find a store\\\",\\n      };\\n    } else if (beautyServiceFaq) {\\n      linkName = \\\"page view\\\";\\n      additionalDataPayload.sotVars = {\\n        sotV88: \\\"happening at sephora beauty services faq\\\",\\n      };\\n    } else if (happeningAtSephora) {\\n      linkName = \\\"page view\\\";\\n      additionalDataPayload.sotVars = {\\n        sotV88: \\\"happening at sephora happening at sephora\\\",\\n      };\\n    } else if (listsLoves) {\\n      linkName = \\\"page view\\\";\\n      additionalDataPayload.sotVars = {\\n        sotV88: \\\"top bar love icon click\\\"\\n      };\\n    } else if (continueShopping) {\\n      linkName = \\\"page view\\\";\\n      additionalDataPayload.sotVars = {\\n        sotV88: \\\"order confirmation continue shopping\\\",\\n      };\\n    } else if (answerIntent) {\\n      linkName = \\\"page view\\\";\\n\\n      additionalDataPayload.sotVars = {\\n        sotV15: productId,\\n        sotV166: questionId,\\n        sotV88: previousPage,\\n      };\\n    } else if (questionAsk) {\\n      linkName = \\\"page view\\\";\\n\\n      additionalDataPayload.sotVars = {\\n        sotV15: productId,\\n        sotV88: previousPage,\\n      };\\n    }\\n    if (beautyInsider) {\\n      linkName = \\\"page view\\\";\\n\\n      additionalDataPayload.sotVars = {\\n        sotV01: \\\"my beauty insider-signed in\\\",\\n        sotV88: \\\"user profile beauty insider click\\\",\\n      };\\n    }\\n    if (applyPercentageOff) {\\n      linkName = \\\"page view\\\";\\n      additionalDataPayload.sotVars = {\\n        sotV88: \\\"bi points for discount apply in basket\\\",\\n      };\\n    }\\n    if (applyCashDiscount) {\\n      linkName = \\\"page view\\\";\\n      additionalDataPayload.sotVars = {\\n        sotV04: cartInfo.sotV04,\\n        sotV11: cartInfo.sotV11,\\n        sotV63: cartInfo.sotV63,\\n        sotV88: \\\"bi beauty insider cash apply in basket\\\",\\n      };\\n    }\\n    if (bookAServiceLanding || bookAServiceConfirmation) {\\n      linkName = \\\"page view\\\";\\n      additionalDataPayload.sotVars = {\\n        sotV88: \\\"service special request\\\",\\n      };\\n    }\\n    if (myCmntyProfile) {\\n      linkName = \\\"page view\\\";\\n\\n      additionalDataPayload.sotVars = {\\n        sotV88: \\\"user profile community profile click\\\",\\n      };\\n    }\\n    if (creditCardProgram) {\\n      linkName = \\\"page view\\\";\\n\\n      additionalDataPayload.sotVars = {\\n        sotV88: \\\"user profile credit card program click\\\",\\n      };\\n    }\\n    if (isPersonalizedBannerViewed) {\\n      linkName = \\\"personalized banner impression\\\";\\n    }\\n    if (\\n      sotSubType === \\\"basket\\\" \\u0026\\u0026\\n      dataToSend.sotVars.sotV88.indexOf(\\\"top nav:basket\\\") != -1\\n    ) {\\n      additionalDataPayload.sotVars = {\\n        sotV04: cartInfo.sotV04,\\n        sotV11: cartInfo.sotV11,\\n        sotV63: cartInfo.sotV63,\\n        sotV88: \\\"top bar basket icon click\\\"\\n      }\\n    }\\n    if (\\n      dataToSend.sotVars.sotV106 \\u0026\\u0026\\n      dataToSend.sotVars.sotV106.indexOf(\\\"lists-loves\\\") !== -1 \\u0026\\u0026\\n      sotSubType === \\\"product\\\"\\n    ) {\\n      additionalDataPayload.sotVars = {\\n        sotV88: \\\"product item click from collection\\\",\\n        sotV187: digitalData.page.attributes.customerZipCode,\\n        sotV188: digitalData.product[0].attributes.isOnlineOnly ? \\\"Yes\\\" : \\\"No\\\",\\n        sotV189: digitalData.page.attributes.isSameDayDeliveryAvailable\\n          ? \\\"Yes\\\"\\n          : \\\"No\\\",\\n        sotV192: digitalData.product[0].attributes.nthLevelCategory,\\n        sotV158: \\\"Love\\\",\\n        sotV15: getProductIdforSotV15(),\\n      };\\n    }\\n    if (dataToSend.sotVars.sotV01.indexOf(\\\"ratings\\u0026reviews-write\\\") != -1) {\\n      additionalDataPayload.sotVars = {\\n        sotSubCategory: pageWorld,\\n      };\\n    }\\n    if (\\n      sotSubType === \\\"creditcard\\\" \\u0026\\u0026\\n      dataToSend.sotVars.sotV01.indexOf(\\\"credit card\\\") != -1\\n    ) {\\n      additionalDataPayload.pageInfo.title =\\n        \\\"creditcard:creditcard marketing page:n/a:*\\\";\\n      additionalDataPayload.sotVars = {\\n        sotV01: \\\"creditcard marketing page\\\",\\n      };\\n    }\\n    if (\\n      sotSubType === \\\"reviews\\\" \\u0026\\u0026\\n      dataToSend.sotVars.sotV01.indexOf(\\\"ratings\\u0026reviews-select sku\\\") != -1\\n    ) {\\n      additionalDataPayload.sotVars = {\\n        sotSubCategory: pageWorld,\\n      };\\n    }\\n     \\n   //SA-1322,SA-1534,XSEL-4256, SA-1210\\n    if(digitalData) {\\n      let productAttributes = digitalData.product \\u0026\\u0026 digitalData.product.length \\u0026\\u0026 digitalData.product[0] \\u0026\\u0026 digitalData.product[0].attributes || {};\\n      let productPageInfo = digitalData.product \\u0026\\u0026 digitalData.product.length \\u0026\\u0026 digitalData.product[0] \\u0026\\u0026 digitalData.product[0].productInfo || {};\\n      let pageAttributes = digitalData.page \\u0026\\u0026 digitalData.page.previousPageInfo \\u0026\\u0026 digitalData.page.previousPageInfo.attributes || {};\\n      let lowInStockStatus = productAttributes.isOutOfStock ? \\\"n/a\\\" : productAttributes.isOnlyFewLeft ? \\\"Yes\\\" : \\\"No\\\";\\n      const {listType, carouselProductIndex, preferredStoreId, previousActionType, productId} = pageAttributes;\\n      var position = parseInt(carouselProductIndex, 10) + 1 || null;\\n      let sotV289Val = digitalData?.page?.attributes?.totalBasketCount ? digitalData.page.attributes.totalBasketCount : null;\\n      let sotV290Val = digitalData?.page?.attributes?.isOutOfStock ? \\\"Yes\\\" : productAttributes.isOutOfStock ? \\\"Yes\\\" : \\\"No\\\";\\n      let sotV188 = productAttributes?.isOnlineOnly ? \\\"Yes\\\" : \\\"No\\\";\\n      let sotV211 = productAttributes?.isAppExclusive ? \\\"Yes\\\" : \\\"No\\\";\\n      let sotV189 = digitalData?.page?.attributes?.isSameDayDeliveryAvailable ? \\\"Yes\\\" : \\\"No\\\";\\n    additionalDataPayload.sotVars = {\\n       sotV05: (sotSubType === \\\"product\\\") ? 1 : null,\\n       sotV15: getProductIdforSotV15() || productID || cartInfo.sotV15 || productId || \\\"\\\",\\n       sotV63: getShippingMethod(),\\n       sotV88:  previousActionType || \\\"\\\",\\n       sotV158: listType || \\\"\\\",\\n       sotV187: getCustomerZipCode(),\\n       sotV188,\\n       sotV189,\\n       sotV192: pageWorld,\\n       sotV193: preferredStoreId || \\\"\\\",\\n       sotV199: getStockAvailability(lowInStockStatus),\\n       sotV211,\\n       sotV234: position || \\\"\\\",\\n       sotV236: lowInStockStatus,\\n       sotV237: _satellite.getVar(\\\"[SOT] Page :: language locale\\\") || languageLocale,\\n       sotV289: sotV289Val || getTotalNumberItems() || 0,\\n       sotV290: sotV290Val,\\n       sotV215: productPageInfo?.productName || \\\"\\\"\\n    };\\n   }\\n    //XSEL-4162\\n    if(sotSubType === \\\"user profile\\\" \\u0026\\u0026 safelyReadProperty(\\\"sotVars.sotV01\\\", dataToSend).indexOf(\\n        \\\"lists-loves\\\"\\n      ) != -1) {\\n       let { totalItems, inStockItems, outOfStockItems } = getShoppingListCount();\\n       let { totalBasketCount = null, totalInStockCount = null, totalLovesCount = null, totalOuOfStockCount = null } = digitalData.page.pageInfo;\\n         additionalDataPayload.sotVars = {\\n            sotV289: totalBasketCount || digitalData?.page?.attributes?.totalBasketCount || getTotalNumberItems() || 0,\\n            sotV292: totalLovesCount || totalItems,\\n            sotV293: totalOuOfStockCount || outOfStockItems,\\n            sotV294: totalInStockCount || inStockItems\\n         };\\n    }\\n    \\n    //XSEL-4257\\n    if(isotViewCategory) {\\n     let urlPath = window.location.pathname || safelyReadProperty(\\\"renderQueryParams.urlPath\\\", Sephora);\\n       additionalDataPayload.sotVars = {\\n         sotV182: urlPath || \\\"\\\",\\n         sotV289: digitalData?.page?.attributes?.totalBasketCount || getTotalNumberItems() || 0\\n       };\\n     }\\n\\n    if (sotSubType === 'basket' \\u0026\\u0026 !dataToSend.sotVars.sotV01) {\\n      dataToSend.sotVars.sotV01 = sotSubType;\\n    }\\n    \\n     //SA-1111\\n    if(digitalData \\u0026\\u0026 digitalData.page \\u0026\\u0026 digitalData.page.attributes \\u0026\\u0026 digitalData.page.attributes.linkData === \\\"product:shade finder-results:banner\\\") {\\n      linkName = \\\"page view\\\";\\n      additionalDataPayload.pageInfo = {\\n        title: digitalData.page.attributes.pageName || \\\"product:shade finder-results:n/a:*\\\",\\n      }\\n      additionalDataPayload.sotVars = {\\n        sotV01:  digitalData.page.attributes.pageDetail || \\\"shade finder-results\\\",\\n        sotSubType: digitalData.page.attributes.pageType || \\\"product\\\"\\n      };\\n    }\\n    \\n    \\n    var callNewEvtApi = false;\\n    if (set14OnwardsEvents.indexOf(linkName) \\u003e -1) {\\n      callNewEvtApi = true;\\n    }\\n\\n    if (\\n      isSearchEvent ||\\n      isLogoutEvent ||\\n      isTierVibMigration ||\\n      isTierRougeMigration ||\\n      storeLocator ||\\n      listsLoves ||\\n      continueShopping ||\\n      happeningAtSephora ||\\n      answerIntent ||\\n      beautyServiceFaq ||\\n      isChatRedirect ||\\n      questionAsk ||\\n      beautyInsider ||\\n      myCmntyProfile ||\\n      creditCardProgram ||\\n      bookAServiceLanding ||\\n      bookAServiceConfirmation ||\\n      applyPercentageOff ||\\n      applyCashDiscount ||\\n      followersPageView ||\\n      isPersonalizedBannerViewed\\n    ) {\\n      var finalAllowedPayload = mergeSotVars(dataToSend, additionalDataToSend);\\n      var isValidLinkName = getValidLinkName(linkName);\\n      //console.log('isValidLinkName---\\u003e', isValidLinkName);\\n      if(isValidLinkName) {\\n        var formattedSotType = formatSotType(linkName);\\n        if (formattedSotType === 'page view' || isSearchEvent) {\\n          finalAllowedPayload.sotVars.sotV277 = ipAddress;\\n        }\\n        (window.sephoraOneTag_cmds = window.sephoraOneTag_cmds || []).push([\\n        \\\"trackEvent\\\",\\n        formattedSotType,\\n        finalAllowedPayload,\\n        null,\\n        callNewEvtApi,\\n      ]); \\n      }\\n    }\\n    \\n    // SA-1619 - sotV277 for page view\\n    dataToSend.sotVars.sotV277 = ipAddress;\\n\\n    var finalAllowedPayload = mergeSotVars(dataToSend, additionalDataPayload);\\n    (window.sephoraOneTag_cmds = window.sephoraOneTag_cmds || []).push([\\n      \\\"trackPageView\\\",\\n      finalAllowedPayload,\\n    ]);\\n    if (linkName === \\\"Logout\\\") {\\n      // if logout clear ssi cookies\\n      deleteCookie(\\\"ssi\\\");\\n    }\\n\\n    // Write a review\\n    let pathName = window.location.pathname;\\n    if (pathName === '/addReview' \\u0026\\u0026 safelyReadProperty(\\\"page.pageInfo.pageName\\\", digitalData).indexOf(\\\"ratings\\u0026reviews\\\") != -1) {\\n      additionalDataToSend.sotVars = {\\n        sotV15: productId,\\n      };\\n      var finalPayload = mergeSotVars(dataToSend, additionalDataToSend);\\n      setTimeout(() =\\u003e {\\n        // SA-1619 - sotV277 for page view only\\n        finalPayload.sotVars.sotV277 = '';\\n        (window.sephoraOneTag_cmds = window.sephoraOneTag_cmds || []).push(['trackEvent', 'write a review', finalPayload, null, true]);\\n      }, 100);\\n    }\\n    \\n    //AQME-4838  \\n    const affiliateGateway = _satellite.getVar(\\\"[SOT] :: Affiliate Gateway\\\") || {};\\n    \\n    const {\\n       sotToRead = \\\"0\\\", // Default to \\\"0\\\" if not present\\n       siteId = \\\"\\\",     // Default to an empty string\\n       referrer = \\\"\\\",   // Default to an empty string\\n       gatewayLink = \\\"\\\", // Default to an empty string\\n       linkshareTimeStamp = \\\"\\\", // Default to an empty string\\n       redirectUrl = \\\"\\\"\\n    } = affiliateGateway;\\n\\n    if (sotToRead === \\\"1\\\") {    // If it is equal to \\\"1\\\", then SOT should capture the data from localStorage and send it to SOT backend.\\n    const additionalDataToSend = {\\n      sysInfo: {\\n        userLanguage: languageLocale,\\n        ipAddress: ipAddress,\\n      },\\n      pageInfo: {\\n        title: pageTitle,\\n      },\\n      eventTime: timestamp,\\n      eventId: _satellite.getVar(\\\"[UEID] :: Universal Event ID Fx\\\")(event) || _satellite.getVar(\\\"[TMS] :: Event Id\\\"),\\n      session: {\\n           biId: biAccountId,\\n           biTier: biStatus,\\n           biPoints: biPoints,\\n           profileId: profileId || Sephora.Util.getBasketCache()?.profileId || \\\"\\\",\\n           platform: platform,\\n           emailId: emailId,\\n           signInState: signInStatus,\\n           atgId: _satellite.getVar(\\n             \\\"[TMS] Async :: User :: ATG ID - page load or async page load\\\"\\n           ),\\n           timestamp: timestamp,\\n        },\\n      sotVars: {\\n            sotV181: redirectUrl,\\n            sotV278: referrer,\\n            sotV285: _satellite.readCookie(\\\"linkShareTime\\\") || \\\"\\\",\\n            sotV286: _satellite.readCookie(\\\"siteId\\\") || \\\"\\\",\\n            sotV345: linkshareTimeStamp,     // localstorage linkshareTime\\n            sotV346: siteId,      //localstorage siteId\\n            sotV347: gatewayLink,  // affiliate gateway link\\n        }\\n    };\\n\\n    const affiliateGatewayPayload = mergeSotVars(dataToSend, additionalDataToSend);\\n\\n    setTimeout(() =\\u003e {\\n        (window.sephoraOneTag_cmds = window.sephoraOneTag_cmds || []).push(['trackEvent', 'affiliategateway', affiliateGatewayPayload, null, true]);\\n        updateAffiliateGateway();  // the localStorage.sotToRead should be set to \\\"0\\\"\\n    }, 100);\\n   }\\n\\n    //AQME-5000\\n    const linkshareTime = JSON.parse(localStorage.getItem(\\\"linkshareTime\\\"))?.data;\\n    const linkshareSiteId = JSON.parse(localStorage.getItem(\\\"linkshareSiteId\\\"))?.data;\\n    const rakutenAttrSource = JSON.parse(localStorage.getItem(\\\"rakutenAttrSource\\\"))?.data;\\n    const rakutenOrderNeedsToBeStoredBySot = JSON.parse(localStorage.getItem(\\\"rakutenOrderNeedsToBeStoredBySot\\\"))?.data;\\n    const rakutenOrderNumber = JSON.parse(localStorage.getItem(\\\"rakutenOrderNumber\\\"))?.data;\\n\\n    if (rakutenOrderNeedsToBeStoredBySot === true) {\\n    const additionalDataToSend = {\\n      sysInfo: {\\n        userLanguage: languageLocale,\\n        ipAddress: ipAddress,\\n      },\\n      pageInfo: {\\n        title: pageTitle,\\n      },\\n      eventTime: timestamp,\\n      eventId: _satellite.getVar(\\\"[UEID] :: Universal Event ID Fx\\\")(event) || _satellite.getVar(\\\"[TMS] :: Event Id\\\"),\\n      session: {\\n           biId: biAccountId,\\n           biTier: biStatus,\\n           biPoints: biPoints,\\n           profileId: profileId || Sephora.Util.getBasketCache()?.profileId || \\\"\\\",\\n           platform: platform,\\n           emailId: emailId,\\n           signInState: signInStatus,\\n           atgId: _satellite.getVar(\\n             \\\"[TMS] Async :: User :: ATG ID - page load or async page load\\\"\\n           ),\\n           timestamp: timestamp,\\n        },\\n      sotVars: {\\n            sotV285: linkshareTime || _satellite.readCookie(\\\"linkShareTime\\\") || \\\"\\\",\\n            sotV286: _satellite.readCookie(\\\"siteId\\\") || \\\"\\\",\\n            sotV358: linkshareSiteId,\\n            sotV359: rakutenAttrSource,\\n            sotV360: rakutenOrderNumber\\n        }\\n    };\\n\\n    const rakutenOrderPayload = mergeSotVars(dataToSend, additionalDataToSend);\\n\\n    setTimeout(() =\\u003e {\\n        (window.sephoraOneTag_cmds = window.sephoraOneTag_cmds || []).push(['trackEvent', 'affiliate_order', rakutenOrderPayload, null, true]);\\n        updateRakutenOrderParams();\\n    }, 100);\\n   }   \\n\\n\\n    if (document.referrer \\u0026\\u0026 document.referrer.indexOf('sephora.com') \\u003c 0 \\u0026\\u0026 document.isUniversalLinkOpened !== true) {\\n      var omMmc = url.searchParams.get(\\\"om_mmc\\\");\\n      var pathname = window.location.pathname;\\n      document.isUniversalLinkOpened = true;\\n      additionalDataToSend.sotVars = {\\n        sotV181: url_string,\\n        sotV182: pathname \\u0026\\u0026 (pathname.charAt(0) === '/' ? pathname.substring(1) : pathname),\\n        sotV183: omMmc ? ('om_mmc=' + omMmc) : '',\\n        sotV278: document.referrer,\\n        sotV348: omMmc\\n      };\\n      var finalDataPayload = mergeSotVars(dataToSend, additionalDataToSend);\\n      setTimeout(() =\\u003e {\\n        // SA-1619 - sotV277 for page view only\\n        finalDataPayload.sotVars.sotV277 = '';\\n        (window.sephoraOneTag_cmds = window.sephoraOneTag_cmds || []).push(['trackEvent', 'universal link open browser', finalDataPayload, null, true]);\\n      }, 100);\\n    }\\n  }\\n  catch (error) {\\n    console.log(\\\"Failed in SOT - Page View Tag\\\", error);\\n  }\\n})();\\n\",\"language\":\"javascript\"}"
    },
    "relationships": {
        "updated_with_extension_package": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RCac22381a47a74401931e85a12f13559d/updated_with_extension_package"
            },
            "data": {
                "id": "EP1fdd2a6ec2ae468fb1d2cac08df65f83",
                "type": "extension_packages"
            }
        },
        "updated_with_extension": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RCac22381a47a74401931e85a12f13559d/updated_with_extension"
            },
            "data": {
                "id": "EX35ce3802460d499b9f4c856d69a764b4",
                "type": "extensions"
            }
        },
        "extension": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RCac22381a47a74401931e85a12f13559d/extension"
            },
            "data": {
                "id": "EX881e591abc3d4b29b9681e2a4d337f74",
                "type": "extensions"
            }
        },
        "notes": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RCac22381a47a74401931e85a12f13559d/notes"
            }
        },
        "origin": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RCac22381a47a74401931e85a12f13559d/origin"
            },
            "data": {
                "id": "RCac22381a47a74401931e85a12f13559d",
                "type": "rule_components"
            }
        },
        "property": {
            "links": {
                "related": "https://reactor.adobe.io/properties/PR28bc45fcba184e70b64b2f0cf7fe70f8"
            },
            "data": {
                "id": "PR28bc45fcba184e70b64b2f0cf7fe70f8",
                "type": "properties"
            }
        },
        "rules": {
            "links": {
                "related": "https://reactor.adobe.io/rule_components/RCac22381a47a74401931e85a12f13559d/rules"
            }
        }
    },
    "links": {
        "extension": "https://reactor.adobe.io/extensions/EX881e591abc3d4b29b9681e2a4d337f74",
        "origin": "https://reactor.adobe.io/rule_components/RCac22381a47a74401931e85a12f13559d",
        "rules": "https://reactor.adobe.io/rule_components/RCac22381a47a74401931e85a12f13559d/rules",
        "self": "https://reactor.adobe.io/rule_components/RCac22381a47a74401931e85a12f13559d"
    },
    "meta": {
        "latest_revision_number": 178
    }
}
